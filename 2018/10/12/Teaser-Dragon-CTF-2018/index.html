<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="pwn," />










<meta name="description" content="Production这题据说是远程没有启用assert，导致文件没有close。但我当时没看出来，现在平台关闭了也试不了了TAT，就看了些大佬（Ne0 和dcua ）的wp，了解这个漏洞是怎么用的。duca的wp更细一点，两者结合更容易理解。 相关知识关于assert  DESCRIPTION If the macro NDEBUG was defined at the moment  was l">
<meta name="keywords" content="pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="Teaser Dragon CTF 2018">
<meta property="og:url" content="http://0gur1.cc/2018/10/12/Teaser-Dragon-CTF-2018/index.html">
<meta property="og:site_name" content="0gur1">
<meta property="og:description" content="Production这题据说是远程没有启用assert，导致文件没有close。但我当时没看出来，现在平台关闭了也试不了了TAT，就看了些大佬（Ne0 和dcua ）的wp，了解这个漏洞是怎么用的。duca的wp更细一点，两者结合更容易理解。 相关知识关于assert  DESCRIPTION If the macro NDEBUG was defined at the moment  was l">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-11-22T12:23:21.074Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Teaser Dragon CTF 2018">
<meta name="twitter:description" content="Production这题据说是远程没有启用assert，导致文件没有close。但我当时没看出来，现在平台关闭了也试不了了TAT，就看了些大佬（Ne0 和dcua ）的wp，了解这个漏洞是怎么用的。duca的wp更细一点，两者结合更容易理解。 相关知识关于assert  DESCRIPTION If the macro NDEBUG was defined at the moment  was l">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
	  applicationID: '7MHLMVVD1M',
      apiKey: 'dbb74cd528079f8c1d1a6138e9ed5b67',
      indexName: 'test_hexo',
      hits: "",
      labels: ""
    }
  };
</script>



  <link rel="canonical" href="http://0gur1.cc/2018/10/12/Teaser-Dragon-CTF-2018/"/>





  <title>Teaser Dragon CTF 2018 | 0gur1</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">0gur1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  <!-- -->
  
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      

    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://0gur1.cc/2018/10/12/Teaser-Dragon-CTF-2018/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="0gur1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0gur1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Teaser Dragon CTF 2018</h1>
        

        <div class="post-meta">
		  
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-12T20:01:38+08:00">
                2018-10-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/10/12/Teaser-Dragon-CTF-2018/" class="leancloud_visitors" data-flag-title="Teaser Dragon CTF 2018">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,695字
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Production"><a href="#Production" class="headerlink" title="Production"></a>Production</h1><p>这题据说是远程没有启用assert，导致文件没有close。但我当时没看出来，现在平台关闭了也试不了了TAT，就看了些大佬（<a href="https://changochen.github.io/2018/09/29/Teaser-Dragon-CTF-2018/" target="_blank" rel="noopener">Ne0</a> 和<a href="https://ctftime.org/writeup/11454" target="_blank" rel="noopener">dcua</a> ）的wp，了解这个漏洞是怎么用的。duca的wp更细一点，两者结合更容易理解。</p>
<h2 id="相关知识"><a href="#相关知识" class="headerlink" title="相关知识"></a>相关知识</h2><p><strong>关于assert</strong></p>
<blockquote>
<p><strong>DESCRIPTION</strong> If the macro NDEBUG was defined at the moment <assert.h> was last included, the macro assert() generates no code, and hence does nothing at all. Otherwise, the macro assert() prints an error message to standard error and terminates the program by calling abort(3) if expression is false (i.e., compares equal to zero).</assert.h></p>
</blockquote>
<p>如果assert.h中包含了宏NDEBUG，assert将不生成代码，不执行任何操作；否则当assert中的条件不满足时，assert会输出错误并终止程序。</p>
<p>也就是说，如果远程assert.h中有NDEBUG，那么在read_lyrics中的关闭文件操作就不会执行：</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(buffer, <span class="string">"DrgnS"</span>)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[-] Attack detected and stopped!\n"</span>);</span><br><span class="line"></span><br><span class="line">    assert(close(globals::records[idx]) == <span class="number">0</span>);</span><br><span class="line">    memmove(&amp;globals::records[idx], &amp;globals::records[idx + <span class="number">1</span>],</span><br><span class="line">            (globals::records.size() - idx - <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    globals::records.pop_back();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>memmove通过数组的前移实现删除，因此当读到的内容包含“DrgnS”时，只会在数组中删除元素，但文件仍处于打开状态，即fd的数量没有减少。</p>
<p><strong>关于setrlimit</strong></p>
<p>程序进行了一些限制，其中就包含能够打开文件描述符的最大值：</p>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rlim.rlim_cur = rlim.rlim_max = <span class="number">32</span>;</span><br><span class="line">setrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br></pre></td></tr></table></figure>
<p>打开的文件个数超过32个时，再通过open打开文件就会失败。观察open_lyrics的检查顺序，有两个用到open的操作位于flag之前，因此可以通过这一操作绕过flag的读取。</p>
<p>另外，程序中限制输入的band或者song中不能包含“../”，但是可以输入“..”绕过。</p>
<h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2><p>参考<a href="https://changochen.github.io/2018/09/29/Teaser-Dragon-CTF-2018/" target="_blank" rel="noopener">Ne0大佬</a> 的思路。</p>
<ol>
<li>在lyrics二进制文件中有“DrgnS”字符串，因此打开16次该文件（./data/../lyrics），然后读取内容，每次都读到“DrgnS”处，此时fd为18(包含0,1,2标准的输入输出)，而record数组因为memmove，元素都被删除了，size为0。</li>
<li>打开12个任意的文件，此时fd为30.</li>
<li>open_lyrics  ./data/../flag，在read_lyrics先是检查path是否为一个文件时，open文件，这时fd1为31，文件描述符有32个，把文件放入数组后，又检查path是否为链接文件，再次open，这时fd2=-1，并返回true。由此绕过了flag的检查</li>
</ol>
<figure class="highlight cc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Open the path, make sure that it's a file (and not e.g. directory), and</span></span><br><span class="line"><span class="comment">// save the file descriptor.</span></span><br><span class="line"><span class="keyword">int</span> fd1 = open(path, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (fd1 == <span class="number">-1</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"><span class="keyword">if</span> (fstat(fd1, &amp;st) != <span class="number">0</span> || !S_ISREG(st.st_mode)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">globals::records.push_back(fd1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Better safe then sorry. Make sure that the path also doesn't point to a</span></span><br><span class="line"><span class="comment">// symbolic link.</span></span><br><span class="line"><span class="keyword">int</span> fd2 = open(path, O_RDONLY | O_NOFOLLOW);</span><br><span class="line"><span class="keyword">if</span> (fd2 == <span class="number">-1</span>) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"[-] Detected attempt to open a symbolic link!\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Some kind of attack detected?</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">close(fd2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Extra check to protect the flag.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(path, <span class="string">"flag"</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"[-] Not today\n"</span>);</span><br><span class="line"></span><br><span class="line">  close(globals::records.back());</span><br><span class="line">  globals::records.pop_back();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>由于flag中也包含“DrgnS”字符串，因此无法直接打印出来。read_line_buffered中，如果读到文件结尾处会返回0，buffer中的内容不会改变。并且如果连续调用read_line_buffered时，buffer在栈上的地址保持不变，内容也就不变。因此可以先对某个文件读到结尾，再读flag，再返回读那个文件，buffer中就会保持flag中的内容。</li>
</ol>
<h1 id="Fast-Storage"><a href="#Fast-Storage" class="headerlink" title="Fast Storage"></a>Fast Storage</h1><p>这题用到了一个奇怪的点：abs(0x80000000)==0x80000000。从开始看大佬的wp到自己捋顺一共花了两天时间ORZ。</p>
<h2 id="基本逻辑"><a href="#基本逻辑" class="headerlink" title="基本逻辑"></a>基本逻辑</h2><p>add，print和edit功能。</p>
<p>add函数输入name、size和value，并对size和value地址做简单的处理后一起存放。题目中实现了一个类似于哈希表的简单结构：对name进行哈希作为索引，出现碰撞后用next字段链接起来。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__<span class="function">fastcall <span class="title">add</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rbx@7</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax@7</span></span><br><span class="line">  <span class="keyword">char</span> *name; <span class="comment">// rax@9</span></span><br><span class="line">  <span class="keyword">size_t</span> size; <span class="comment">// [sp+8h] [bp-128h]@1</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [sp+10h] [bp-120h]@1</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [sp+10Fh] [bp-21h]@3</span></span><br><span class="line">  <span class="keyword">void</span> *value_addr; <span class="comment">// [sp+110h] [bp-20h]@1</span></span><br><span class="line">  __int64 v11; <span class="comment">// [sp+118h] [bp-18h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">  v11 = <span class="number">0L</span>L;</span><br><span class="line">  size = <span class="number">0L</span>L;</span><br><span class="line">  value_addr = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Name: "</span>, a2, &amp;buf);</span><br><span class="line">  v2 = fileno(<span class="built_in">stdin</span>);</span><br><span class="line">  v11 = read(v2, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( v11 &lt;= <span class="number">0</span> )</span><br><span class="line">    ouch();</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Size: "</span>, &amp;buf);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%lu"</span>, &amp;size);</span><br><span class="line">  fgetc(<span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x400</span> )</span><br><span class="line">    ouch();</span><br><span class="line">  value_addr = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !value_addr )</span><br><span class="line">    ouch();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Value: "</span>, &amp;size);</span><br><span class="line">  v3 = size;</span><br><span class="line">  v4 = fileno(<span class="built_in">stdin</span>);</span><br><span class="line">  v11 = read(v4, value_addr, v3);</span><br><span class="line">  <span class="keyword">if</span> ( v11 &lt;= <span class="number">0</span> )</span><br><span class="line">    ouch();</span><br><span class="line">  value_addr = (<span class="keyword">void</span> *)((size &lt;&lt; <span class="number">48</span>) | (<span class="keyword">unsigned</span> __int64)value_addr);</span><br><span class="line">  name = strdup(&amp;buf);</span><br><span class="line">  <span class="keyword">return</span> insert_item((__int64)name, (__int64)value_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其种insert_item函数是对name作一些运算并进行插入操作。我用的IDA6.8版本的就看不出来用了abs函数（当然即使看出来也不觉得有问题），据说7.0的可以直接显示。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__<span class="function">fastcall <span class="title">insert_item</span><span class="params">(__int64 name, __int64 content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// ST1C_4@1</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ST18_4@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// ST14_4@1</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// ST1C_4@1</span></span><br><span class="line"></span><br><span class="line">  v2 = h1((_BYTE *)name);</span><br><span class="line">  v3 = h2(name);</span><br><span class="line">  v4 = h3((_BYTE *)name);</span><br><span class="line">  idx = ((v2 ^ (v2 &gt;&gt; <span class="number">31</span>)) - (v2 &gt;&gt; <span class="number">31</span>)) % <span class="number">62</span>;  <span class="comment">// abs</span></span><br><span class="line">  insert_idx(idx, name, content);</span><br><span class="line">  <span class="keyword">return</span> set_hash_bits(idx, v3, v4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过insert_idx函数了解到哈希链表结点的结构。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">_QWORD *__<span class="function">fastcall <span class="title">insert_idx</span><span class="params">(<span class="keyword">int</span> idx, __int64 name, __int64 content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax@3</span></span><br><span class="line">  __int64 v4; <span class="comment">// [sp+8h] [bp-28h]@1</span></span><br><span class="line">  _QWORD *v5; <span class="comment">// [sp+28h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v4 = content;</span><br><span class="line">  v5 = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    ouch();</span><br><span class="line">  v5[<span class="number">1</span>] = name;</span><br><span class="line">  v5[<span class="number">2</span>] = v4;</span><br><span class="line">  *v5 = entry[idx];</span><br><span class="line">  result = entry;</span><br><span class="line">  entry[idx] = v5;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> * <span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">char</span> * name;</span><br><span class="line">    <span class="keyword">char</span> * value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>set_hash_bits函数用位运算记录h2和h3的结果：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__<span class="function">fastcall <span class="title">set_hash_bits</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">char</span> a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// rax@1</span></span><br><span class="line"></span><br><span class="line">  result = bits;</span><br><span class="line">  bits[idx] |= (<span class="number">1</span> &lt;&lt; a2) | (<span class="number">1</span> &lt;&lt; a3);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>print和edit都是通过name定位到结点，输出或修改value的值。</p>
<p>find_by_name函数中同样用到了h1，h2，h3函数，并在遍历链表前先对bits[idx]进行检查，查看bits[idx]是否有对应的几个bit。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">find</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax@4</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 *size; <span class="comment">// [sp+0h] [bp-120h]@1</span></span><br><span class="line">  __int64 *content_addr; <span class="comment">// [sp+8h] [bp-118h]@1</span></span><br><span class="line">  <span class="keyword">char</span> name; <span class="comment">// [sp+10h] [bp-110h]@1</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// [sp+10Fh] [bp-11h]@3</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [sp+110h] [bp-10h]@1</span></span><br><span class="line">  __int64 v9; <span class="comment">// [sp+118h] [bp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;name, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">  v9 = <span class="number">0L</span>L;</span><br><span class="line">  v8 = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Name: "</span>, a2, a2, a1);</span><br><span class="line">  v2 = fileno(<span class="built_in">stdin</span>);</span><br><span class="line">  v9 = read(v2, &amp;name, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">    ouch();</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v8 = find_by_name(&amp;name);</span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    *size = v8 &gt;&gt; <span class="number">0x30</span>;</span><br><span class="line">    *content_addr = v8 &amp; <span class="number">0xFFFFFFFFFFFF</span>LL;</span><br><span class="line">    result = <span class="number">1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __<span class="function">fastcall <span class="title">find_by_name</span><span class="params">(<span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// ST24_4@1</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST20_4@1</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// al@1</span></span><br><span class="line">  __int64 result; <span class="comment">// rax@2</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// [sp+24h] [bp-Ch]@1</span></span><br><span class="line">  __int64 i; <span class="comment">// [sp+28h] [bp-8h]@3</span></span><br><span class="line"></span><br><span class="line">  v1 = h1(name);</span><br><span class="line">  v2 = h2((__int64)name);</span><br><span class="line">  v3 = h3(name);</span><br><span class="line">  idx = ((v1 ^ (v1 &gt;&gt; <span class="number">31</span>)) - (v1 &gt;&gt; <span class="number">31</span>)) % <span class="number">62</span>; <span class="comment">//abs</span></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)check(idx, v2, v3) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = entry[idx]; i &amp;&amp; <span class="built_in">strcmp</span>(*(<span class="keyword">const</span> <span class="keyword">char</span> **)(i + <span class="number">8</span>), name); i = *(_QWORD *)i )</span><br><span class="line">      ;</span><br><span class="line">    result = *(_QWORD *)(i + <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__int64 __<span class="function">fastcall <span class="title">check</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">char</span> a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (((<span class="number">1</span> &lt;&lt; a2) | (<span class="number">1</span> &lt;&lt; a3)) &amp; bits[idx]) == ((<span class="number">1</span> &lt;&lt; a2) | (<span class="number">1</span> &lt;&lt; a3));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bugs"><a href="#bugs" class="headerlink" title="bugs"></a>bugs</h2><p>大佬们究竟是怎么想到的？？</p>
<p>abs(0x80000000)==0x80000000。验证一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0x80000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%#x\n"</span>,a^(a&gt;&gt;<span class="number">31</span>)-a&gt;&gt;<span class="number">31</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%#x\n"</span>,<span class="built_in">abs</span>(a));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./test</span><br><span class="line">-2147483648</span><br><span class="line">0x80000000</span><br><span class="line">0x80000000</span><br></pre></td></tr></table></figure>
<p>如果h1(name)为0x80000000，idx = abs(0x80000000)%62=-2，在insert_idx时进行entry[idx] = node_addr时，实际上是对entry之前的数据进行操作。查看bss结构，entry[-2]即为bits[60]。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000000000202040 ; _DWORD bits[64]</span><br><span class="line">.bss:0000000000202040 bits            dd 40h dup(?)           ; DATA XREF: set_hash_bits+Do</span><br><span class="line">.bss:0000000000202040                                         ; set_hash_bits+3Do ...</span><br><span class="line">.bss:0000000000202140 ; _QWORD entry[62]</span><br><span class="line">.bss:0000000000202140 entry           dq 3Eh dup(?)           ; DATA XREF: insert_idx+4Ao</span><br><span class="line">.bss:0000000000202140</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>当输入特定的name时，会在entry[-2]即bits[60]写入堆地址，而在find_by_name中的check会对bits[60]进行检查，确定是否有某一bit，检查失败会返回”No such entry! “，利用这一点可以对bits[60]中的堆地址进行逐位泄露，方法是暴力破解。</p>
<p>另外，在新增结点时，bit[idx]|=1&lt;&lt;a2|1&lt;&lt;a3，通过操作a2和a3能够修改bit[idx]中的内容，即如果能够修改bit[60]中的堆地址，就相当于修改了entry[-2]的首个结点地址，控制这个堆地址中存放满足条件的name，就能泄露或者修改指定的value值。</p>
<ol>
<li>确定特定的name，使得h1(name)为0x80000000。采用暴力破解的方法。</li>
<li>bit by bit 泄露堆地址，同样也是暴力破解。首先破解特定name满足：h2(name)==h3(name) &amp;&amp; abs(h1(name))%62==60(和61)，这样当a2=a3时，1&lt;&lt;a2|1&lt;&lt;a3就相当于1&lt;&lt;a2，这样就能逐位暴破堆地址了。由于bits数组是DWORD类型的，因此堆地址存放在bits[60]和bits[61]中。Linux系统中规定堆地址为6字节，且最高字节为5x，并且最低1.5字节（12bit）都是从000开始的，因此只需要破解中间的4字节即可。</li>
<li>泄露libc地址。采用的方法是house of orange，修改top的size，得到一个unsorted bin后泄露libc地址。修改top size的方法正如前面所述，先通过位异或修改bit[60]中的堆地址为我们构造好的地址，这个地址作为entry[-2]的首个结点，构造name满足条件，value为top size处的地址，即可通过edit修改top size。这里需要注意的是，修改后的top size需要满足 top end是页对齐的（<a href="http://0gur1.cc/2018/07/10/sysmalloc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">参考sysmalloc的源码</a>）</li>
<li>修改malloc_hook为one_gadget，方法同上。</li>
</ol>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><p>脚本我是参考EmpireCTF队伍的<a href="https://ctftime.org/writeup/11460" target="_blank" rel="noopener">wp</a>，这里就只附上暴破的简单脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">h1</span><span class="params">(s)</span>:</span></span><br><span class="line">	result = <span class="number">4919</span>;</span><br><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">		result = result * ord(c)+<span class="number">1</span></span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">h2</span><span class="params">(s)</span>:</span></span><br><span class="line">	result = <span class="number">0</span></span><br><span class="line">	i=<span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> i+<span class="number">1</span>&lt;len(s) <span class="keyword">and</span> s[i] <span class="keyword">and</span> s[i+<span class="number">1</span>]  :</span><br><span class="line">		tmp = ord(s[i+<span class="number">1</span>])&lt;&lt;<span class="number">8</span> | ord(s[i])</span><br><span class="line">		result ^= tmp</span><br><span class="line">		i+=<span class="number">2</span></span><br><span class="line">	<span class="keyword">if</span> i&lt;len(s) <span class="keyword">and</span> s[i]:</span><br><span class="line">		result ^= ord(s[i])</span><br><span class="line">        <span class="keyword">return</span> ((result&gt;&gt;<span class="number">10</span>) ^ (result ^ (result &gt;&gt; <span class="number">5</span>))) &amp;<span class="number">0x1f</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">h3</span><span class="params">(s)</span>:</span></span><br><span class="line">	result = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">			<span class="keyword">if</span> (ord(c)&gt;&gt;i)&amp;<span class="number">1</span>:</span><br><span class="line">				result+=<span class="number">1</span>;</span><br><span class="line">		result&amp;=<span class="number">0x1f</span>;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line"><span class="comment">#破解h1(name)==0x80000000</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute1</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">255</span>,<span class="number">0</span>,<span class="number">-1</span>):</span><br><span class="line">		<span class="keyword">print</span> i</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">				<span class="keyword">for</span> l <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">					tmp = chr(i)+chr(j)+chr(k)+chr(l)</span><br><span class="line">					<span class="keyword">if</span> h1(tmp)%<span class="number">0x100000000</span> == <span class="number">0x80000000</span>:</span><br><span class="line">						<span class="keyword">print</span> tmp</span><br><span class="line">						<span class="keyword">print</span> <span class="string">"%d %d %d %d"</span> %(i,j,k,l)</span><br><span class="line">						<span class="keyword">return</span></span><br><span class="line"><span class="comment">#破解h2(name)==h3(name) &amp;&amp; abs(h1(name))%62==60(和61)</span></span><br><span class="line"><span class="comment">#i可以从2字节开始逐步增加到4字节</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">brute2</span><span class="params">()</span>:</span></span><br><span class="line">	pos=&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x10000</span>):</span><br><span class="line">		tmp=p32(i)[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line">		a2=h2(tmp)</span><br><span class="line">		a3=h3(tmp)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (abs(h1(tmp))%<span class="number">62</span>)==<span class="number">60</span> <span class="keyword">and</span> a2==a3:</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">not</span> pos.has_key(a2):</span><br><span class="line">				pos[a2]=<span class="number">1</span></span><br><span class="line">				<span class="keyword">print</span> <span class="string">"%d:%#x"</span> %(a2,u32(tmp.ljust(<span class="number">4</span>,<span class="string">'\x00'</span>)))</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/pwn/" rel="tag"># pwn</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/25/IO-FILE的利用/" rel="next" title="IO_FILE的利用">
                <i class="fa fa-chevron-left"></i> IO_FILE的利用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/22/2018护网杯线上赛pwn/" rel="prev" title="2018护网杯线上赛pwn">
                2018护网杯线上赛pwn <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpg"
                alt="0gur1" />
            
              <p class="site-author-name" itemprop="name">0gur1</p>
              <p class="site-description motion-element" itemprop="description">Stay hungry.Stay foolish.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Production"><span class="nav-number">1.</span> <span class="nav-text">Production</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#相关知识"><span class="nav-number">1.1.</span> <span class="nav-text">相关知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用方法"><span class="nav-number">1.2.</span> <span class="nav-text">利用方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Fast-Storage"><span class="nav-number">2.</span> <span class="nav-text">Fast Storage</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本逻辑"><span class="nav-number">2.1.</span> <span class="nav-text">基本逻辑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bugs"><span class="nav-number">2.2.</span> <span class="nav-text">bugs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞利用"><span class="nav-number">2.3.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用脚本"><span class="nav-number">2.4.</span> <span class="nav-text">利用脚本</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0gur1</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客量:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("KvkboNezCqOpWaIBvOMgJE3K-gzGzoHsz", "slQuYxW7tjbda9dyxmi3dY4o");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
